<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT VR Practice - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff; /* UPDATED: Body background to white */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); 
            width: 100%;
            background-color: #ffffff; 
            border: 1px solid #d1d5db; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; 
            margin: 1rem; 
            overflow: hidden; 
        }
        /* Header and Footer */
        .header-bar, .footer-bar {
            flex-shrink: 0; 
            background-color: #006DAA; 
            color: white; 
            padding: 0.75rem 1.5rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar span, .header-bar div {
             color: white;
        }
        #timer {
             background-color: rgba(255, 255, 255, 0.2); 
             color: white;
             font-weight: bold;
             padding: 0.25rem 0.75rem; 
             border-radius: 0.25rem; 
        }
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); 
            padding: 0.4rem 0.8rem; 
            font-size: 0.8rem; 
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); 
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         .footer-bar button#next-button {
             background-color: #ffffff; 
             color: #006DAA; 
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; 
         }
         #flag-button {
             background-color: transparent;
             border: 1px solid white;
             color: white;
             transition: background-color 0.2s ease, color 0.2s ease; 
         }
         #flag-button:hover {
             background-color: white;
             color: #006DAA;
         }
          #flag-button.flagged {
             background-color: #facc15; 
             border-color: #facc15;
             color: #422006; 
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; 
             border-color: #f59e0b;
          }

        .main-content-area {
            flex-grow: 1; 
            display: flex;
            overflow: hidden; 
            padding: 1rem; 
            gap: 1rem; 
        }
        .passage-column {
            flex: 0 0 60%; 
            overflow-y: auto; 
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #ffffff; 
            height: 100%; 
        }
        .question-column {
             flex: 0 0 40%; 
             overflow-y: auto; 
             padding: 1rem;
             border: 1px solid #e5e7eb;
             border-radius: 0.375rem;
             background-color: #ffffff; 
             height: 100%; 
             position: relative; 
        }

        .selected-answer {
            background-color: #bfdbfe !important; 
            border-color: #3b82f6 !important; 
        }
        .nav-answered {
            background-color: #a7f3d0; 
        }
        .nav-current {
            border: 2px solid #3b82f6 !important; 
            font-weight: bold;
        }
        .nav-flagged, .review-flagged {
            border: 2px solid #f59e0b !important; 
            position: relative; 
        }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        .subtle-button { background-color: #f3f4f6; color: #374151; border: 1px solid transparent; }
        .subtle-button:hover:not(:disabled) { background-color: #e5e7eb; }

        .option-label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #ffffff; 
            color: #111827; 
            font-size: 1rem;   
        }
        .option-label:hover:not(.selected-answer) { 
            background-color: #f3f4f6; 
            border-color: #a5b4fc; 
        }
        input[type="radio"] { display: none; }

       .correct-answer-li { background-color: #dcfce7; border-left: 4px solid #22c55e; }
       .incorrect-answer-li { background-color: #fee2e2; border-left: 4px solid #ef4444; }
       .result-item-clickable-li { 
           cursor: pointer;
           transition: background-color 0.2s ease-in-out;
           border: 1px solid #e5e7eb;
           border-radius: 0.5rem;
           margin-bottom: 0.5rem;
           padding: 0.75rem;
       }
       .result-item-clickable-li:hover {
           background-color: #f0f0f0;
       }
       .correct-indicator-text { color: #16a34a; font-weight: 600;}
       .incorrect-indicator-text { color: #dc2626; font-weight: 600;}

        #results-grid-container { 
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 columns */
            grid-template-rows: repeat(2, 1fr); /* 2 rows */
            gap: 0.75rem; /* Balanced spacing between boxes */
            padding: 1rem 0; 
            overflow-y: auto; 
            max-width: 100%; /* Use full width of container */
            width: 100%;
            margin: 0 auto; /* Center the grid */
        }
        .result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Keep boxes square */
            padding: 0.5rem; /* Padding for better content display */
            border-radius: 0.375rem;
            color: white; 
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.25rem;
            width: 100%;
            height: auto;
            min-width: 3rem; /* Minimum width */
        }
        .result-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .result-box-correct {
            background-color: #22c55e; 
            border: 1px solid #16a34a; 
        }
        .result-box-incorrect {
            background-color: #ef4444; 
            border: 1px solid #dc2626; 
        }
        .result-box-flagged { 
            outline: 2px solid #f59e0b; 
            outline-offset: 2px;
        }
        .result-box .time-spent {
            font-size: 1rem; /* Balanced font size */
            font-weight: 600; 
            line-height: 1.1;
        }
        .question-num-label {
            font-size: 0.75rem; /* Balanced font size */
            color: #374151;
            text-align: center;
            width: 100%;
        }
        
        /* Media queries for responsive grid */
        @media (max-width: 992px) {
            #results-grid-container {
                grid-template-columns: repeat(8, 1fr);
                max-width: 100%;
            }
        }
        @media (max-width: 768px) {
            #results-grid-container {
                grid-template-columns: repeat(4, 1fr); /* 4 columns on medium screens */
                grid-template-rows: repeat(4, 1fr); /* 4 rows on medium screens */
                max-width: 100%;
                gap: 0.5rem;
            }
        }
        @media (max-width: 480px) {
            #results-grid-container {
                grid-template-columns: repeat(4, 1fr); /* Changed from 2 to 4 columns */
                grid-template-rows: repeat(4, 1fr); /* Changed from 8 to 4 rows */
                gap: 0.4rem;
            }
            .result-box .time-spent {
                font-size: 0.85rem;
            }
        }
         .explanation-box {
             background-color: #f3f4f6; 
             border: 1px solid #d1d5db;    
             padding: 0.5rem 0.75rem; 
             margin-top: 0.75rem; 
             border-radius: 0.375rem; 
             font-size: 0.875rem; 
             color: #111827; 
         }

         .review-grid-button {
             padding: 0.5rem 0.25rem; 
             border: 1px solid #d1d5db; 
             border-radius: 0.375rem;
             text-align: center;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             font-size: 0.875rem;
             line-height: 1.25rem;
             cursor: pointer;
         }
         .review-grid-button-answered {
             background-color: #dcfce7; 
             border-color: #86efac; 
             color: #15803d; 
         }
         .review-grid-button-unanswered {
             background-color: #f3f4f6; 
             border-color: #d1d5db; 
             color: #4b5563; 
         }
          .review-grid-button:hover {
             filter: brightness(95%); 
          }

        @media (max-width: 768px) {
            #app-container {
                 height: auto; 
                 margin: 0.5rem;
            }
            .main-content-area {
                flex-direction: column; 
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .passage-column, .question-column {
                flex-basis: auto;
                width: 100%; 
                height: auto; 
                max-height: 40vh; 
                padding: 0.75rem;
            }
            .header-bar, .footer-bar {
                padding: 0.5rem 1rem;
            }
            .header-bar span, .footer-bar button { 
                font-size: 0.8rem;
            }
            button, .button {
                padding: 0.4rem 0.8rem;
            }
             .footer-bar button {
                 padding: 0.3rem 0.6rem;
                 font-size: 0.75rem;
             }
            .grid-cols-5 { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            /* #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); } REMOVED to keep 8 columns */
        }
         @media (max-width: 480px) {
             .grid-cols-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); } 
             #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
             .header-bar span, .footer-bar button { font-size: 0.75rem; }
             button, .button {
                 padding: 0.3rem 0.6rem;
             }
              .footer-bar button {
                 padding: 0.25rem 0.5rem;
                 font-size: 0.7rem;
             }
             .option-label { padding: 0.5rem 0.75rem; font-size: 0.875rem;} 
             .review-grid-button { font-size: 0.75rem; }
             /* #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); } REMOVED to keep 8 columns */
         }
         /* UPDATED: Media queries for result box text on smaller screens with 8 columns */
        @media (max-width: 600px) { 
            #results-grid-container {
                gap: 0.25rem; /* Further reduce gap for small screens */
            }
            .result-box .time-spent {
                font-size: 0.875rem; /* text-sm */
            }
            .result-box .question-num-label {
                font-size: 0.6rem; 
            }
        }
        @media (max-width: 400px) { 
            .result-box .time-spent {
                font-size: 0.75rem; /* text-xs */
            }
            .result-box .question-num-label {
                font-size: 0.5rem; 
            }
             .result-box {
                padding: 0.1rem; /* Minimal padding for very small squares */
            }
        }


    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>

    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-20 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">UCAT Verbal Reasoning Practice</h1> <p class="text-gray-900 mt-2">Prepare for the UCAT VR section.</p> <p class="text-sm text-gray-900 mt-4"> This section contains <strong id="setup-question-count">16 questions</strong> and you have <strong id="setup-time-limit">10 minutes</strong> to complete it.
                 </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-900">Name:</label> <input type="text" id="name" name="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter your name">
                </div>
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-900">Goal (Score out of 16):</label> <input type="number" id="goal" name="goal" min="0" max="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 12">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-gray-900">Area of Focus / Intention For Practice:</label> <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., True/False/Can't Tell, Speed">
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="start-button" class="primary-button text-lg px-8 py-3">
                    Start Exam
                </button>
            </div>
        </div>

        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Verbal Reasoning</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="text-base px-3 py-1 rounded-md">10:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 16</span>
                    <button id="flag-button" class="text-sm font-medium border border-white rounded px-2 py-1 transition-colors duration-150">
                         Flag for Review
                    </button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="passage-column">
                    <h3 class="text-lg font-semibold mb-2 sticky top-0 bg-white text-gray-900 pb-1">Passage <span id="passage-number">1</span></h3>
                    <div id="passage-text" class="text-base text-gray-900 leading-relaxed whitespace-pre-wrap">
                        </div>
                </div>

                <div class="question-column">
                     <h4 class="text-md font-semibold mb-3 sticky top-0 bg-white text-gray-900 pb-1">Question <span id="question-number">1</span></h4>
                    <p id="question-text" class="mb-4 text-gray-900 text-base">
                        </p>
                    <div id="options-container" class="space-y-2">
                        </div>
                    <div id="review-explanation-container"></div>
                </div>
            </div>

            <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-exam-button-footer">End Exam</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-gray-900">Review Your Answers</h2> <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-900 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p> <div id="review-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-10 gap-3 mb-6 w-full max-w-3xl">
                </div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="danger-button text-lg px-8 py-3">
                    End Exam & See Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-16 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                 <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Exam Results</h2> </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0 text-gray-900"> <p class="text-lg font-semibold">Your Score: <span id="score" class="text-gray-900">0</span> / <span id="total-questions-results">16</span></p> <p>Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="text-xl font-semibold mb-2 flex-shrink-0 text-gray-900">Detailed Results:</h3> <p class="text-sm text-gray-900 mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-grid-container">
                </div>
            <div class="mt-6 flex-shrink-0 border-t pt-4">
                 <div class="mb-4">
                    <label for="focus-rating" class="block text-md font-semibold text-gray-900 mb-1">My focus out of 5 (1 very low, 5 very high):</label> <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-900 mb-1">Main takeaway from this practice:</label> <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
             <div class="mt-6 text-center flex-shrink-0 flex justify-center space-x-4">
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2">
                    Try Again
                </button>
                <button id="download-pdf-button" class="primary-button px-6 py-2">
                    Download Results PDF
                </button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">Question Navigator</h3> <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-900 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p> <div id="navigator-grid" class="grid grid-cols-5 gap-3">
                    </div>
            </div>
        </div>

    </div>

    <script>
        // --- Data ---
        const passages = [
            // New Passage 1: Brentworth Quarter - Tech Hub
            `In 1938, British statistician Ronald Fisher responded dismissively to a new idea put forward by a younger colleague: that smoking might be linked to lung cancer. At the time, Fisher was a giant of statistical theory, having developed much of the framework for hypothesis testing and experimental design. He argued that correlation did not imply causation and that genetic predisposition could easily account for the link. Ironically, his own methods would later be used to establish the very link he had denied.

Today, the tension Fisher highlighted—between correlation and causation—remains central in the age of machine learning. Algorithms trained on massive datasets may detect subtle patterns, but their decisions often rest on statistical associations, not mechanistic understanding. A medical AI might “learn” that patients wearing hospital gowns are more likely to be diagnosed with severe illness—not because the gown causes the illness, but because the context is confounded.

In response, a subfield of data science has emerged: causal inference. Drawing from counterfactual reasoning and graph theory, researchers like Judea Pearl argue that prediction without causation is like surgery without anatomy: effective only by luck. Yet critics counter that such frameworks still rely on human-chosen models, making objectivity elusive.            

Fisher’s legacy thus endures in an unexpected way. While his stance on tobacco was wrong, his insistence on careful causal reasoning now underpins some of the most pressing debates in science. The challenge today is not simply to ask “What predicts what?”, but rather “What, if anything, causes what to happen?”
            // New Passage 2: Ecological Management
            `Imagine a coastal ecosystem showing early signs of stress – slightly declining fish stocks, occasional algal blooms. A resource manager, wary of past interventions that proved harmful, decides to wait for more definitive data before acting. This is "precautionary inaction." However, the ecosystem rapidly deteriorates, a critical tipping point is crossed, and recovery becomes vastly more expensive and uncertain. The manager has made an error of under-response, where the cost of inaction outweighed the initial risk of a measured intervention.

Conversely, consider a newly detected, non-native insect species in a local forest. Alarmed by potential devastation seen in other regions with different invasive species, authorities launch an immediate, wide-scale pesticide spraying campaign. Later analysis reveals this particular insect was benign, posing no significant threat, and the pesticide inadvertently harmed native pollinator populations. This is "over-intervention," an error of over-response, where the action taken was disproportionate to the actual threat, leading to unintended negative consequences.

Learning to differentiate between genuine threats requiring urgent action and minor fluctuations or misidentified risks is critical in environmental stewardship. It involves balancing the risk of doing too little against the risk of doing too much. The scientist who dismisses early warnings of coral bleaching as "natural variation" without deeper investigation, or the activist who demands a complete halt to a well-regulated local fishery based on isolated incidents, may both be failing to accurately assess the balance of evidence and potential outcomes.`,
            // New Passage 3: Dr. Thorne & Dr. Hanson - Chroniton Particle Theory
            `Dr. Aris Thorne (born 17 March 1935) is a theoretical physicist renowned for his foundational mathematical frameworks. He is most celebrated for his pivotal, though often behind-the-scenes, work with experimentalist Dr. Lena Hanson on the chroniton particle theory. In 1958, Thorne, then a junior researcher at the Cavendish Institute, published a speculative paper on temporal energy fields, which caught Hanson's attention. Hanson, based at CERN, was grappling with anomalous data from her particle collision experiments. Though their initial correspondence was met with scepticism by the broader physics community, they began a fruitful, if sometimes remote, collaboration that spanned decades. Thorne and Hanson were jointly awarded the Nobel Prize in Physics in 1987 for their combined theoretical and experimental work establishing the existence of chronitons.

Their partnership, though producing over fifty co-authored papers, had periods of divergence. Between 1969 and 1973, Thorne focused on cosmological models, publishing his solo treatise "Temporal Mechanics," while Hanson led a large international team at the newly commissioned Stanford Linear Accelerator Center (SLAC), refining detection methods for ephemeral particles. Their direct collaboration resumed intensively in the late 1970s when Hanson's team observed consistent particle decay patterns that perfectly matched Thorne's revised chroniton equations, published in his 1978 paper "Quantum Time." Thorne rarely engaged in direct experimental oversight but provided critical theoretical guidance for Hanson's large-scale projects, such as the "Chronos Array" detector in the early 1980s and the "Temporal Echo" experiment, which involved a global network of observatories. Hanson, in turn, provided the empirical data that validated and refined Thorne's abstract models.

At Thorne's 80th birthday symposium at Cambridge in 2015, Hanson, via video link, highlighted their symbiotic relationship. "Without Aris's equations," she stated, "my team would have been searching in the dark. His theoretical insights were the map." Thorne and Hanson's final joint publication was a review article in "Physics Today" in 2005, summarizing two decades of chroniton research. Their latest independent accolades include Hanson receiving the National Medal of Science in 2011 and Thorne being knighted for services to theoretical physics in 2013.`,
            // New Passage 4: Hospital Director's Speech - Healthcare Reform
            `"Colleagues, friends: I speak to you today with a profound sense of the responsibility we share, deeply grateful for the dedication you demonstrate daily, and ever mindful of the trust our community places in us. I acknowledge the tireless efforts of my predecessor, Dr. Evans, particularly his stewardship during the initial phases of this challenging transition.

Countless medical professionals have dedicated their careers within these walls, through periods of stability and through waves of unprecedented demand. Yet, it is in times of systemic pressure, when resources are strained and the path forward seems uncertain, that our true strength is revealed – not solely through advanced technology or new protocols, but because We, the caregivers, remain committed to the core principles of healing and compassion, enshrined in our professional ethics. So it has always been. So it must continue with each one of us.

That our healthcare system is navigating a profound crisis is no secret. We are confronted by escalating operational costs, a nationwide shortage of specialized staff, and the complex health needs of an aging population. Waiting lists lengthen, burnout is a stark reality, and every shift brings fresh evidence that the current models of care delivery are being tested to their limits, sometimes impacting the very communities we strive to serve.

These are the tangible pressures, documented in reports and spreadsheets. Less quantifiable, but equally significant, is the erosion of morale that can creep in—a weariness that whispers of insurmountable obstacles, that suggests we must temper our aspirations for patient care. Today, I say to you: the challenges are immense, they are complex, and they demand our utmost ingenuity. They will not be overcome swiftly, nor without significant effort. But hear this: they will be addressed. In this moment, we choose resilience over resignation, collaborative innovation over siloed efforts. In this moment, we reaffirm our commitment to excellence, to compassion, and to the unwavering pursuit of our patients' well-being, pushing past the frustrations and the systemic impediments that have, for too long, hindered our progress."`
        ];

        const questions = [
            // Questions for New Passage 1: Brentworth Quarter - Tech Hub
            { passageIndex: 0, text: "Which of the following best describes Elara Vance's initial approach to the Brentworth Quarter project?", options: ["Cautiously optimistic, seeking broad consensus before acting.", "Pragmatically focused on leveraging existing local skills.", "Visionary and tenacious, despite initial scepticism and resource limitations.", "Primarily driven by a desire to emulate German innovation parks precisely."], correctAnswer: "C", explanation: "C (Correct): The passage states she 'championed a radical plan' and that 'Many dismissed the vision as impractical,' 'Funding was scarce, and the local workforce lacked the specific skills. Yet, the initiative persevered.' This combination points to a visionary approach coupled with tenacity.\nA (Incorrect): The passage suggests her plan was 'radical' and met with dismissal, not that she sought broad consensus first. 'Persevered' implies she pushed forward despite a lack of consensus.\nB (Incorrect): The passage explicitly states the 'local workforce lacked the specific skills,' contradicting this option.\nD (Incorrect): While inspired by a German innovation park, the text doesn't suggest a desire for precise emulation. Her plan was 'radical' for Brentworth's context. The inspiration was a catalyst, not a blueprint for exact replication. This tests whether the reader over-interprets 'inspired by.'" },
            { passageIndex: 0, text: "The passage suggests that Silverdale's decline as the dominant tech centre was primarily due to:", options: ["A sudden exodus of talent to the more affordable Brentworth Quarter.", "An inability of its established entities to embrace specialized technological advancements.", "Brentworth actively undercutting Silverdale's operational costs.", "A general downturn in the regional tech industry affecting all centres."], correctAnswer: "B", explanation: "B (Correct): The passage states, 'Silverdale, previously the dominant tech centre in the region, has seen its growth stagnate, as larger corporations proved slow to adapt to niche technological shifts.' This directly supports the idea of an inability to embrace specialized advancements.\nA (Incorrect): While Brentworth attracted talent, the passage frames Silverdale's stagnation as an internal issue of adaptability before mentioning Brentworth's rise as a direct cause for talent drain. The cause is Silverdale's slowness.\nC (Incorrect): Brentworth had a 'cost-effective advantage' due to its spaces, but there's no mention of actively undercutting Silverdale or that this was the primary reason for Silverdale's stagnation. Silverdale's issue was internal.\nD (Incorrect): The passage describes Brentworth as becoming a 'global leader' and attracting investment, which contradicts a general regional downturn. This is a distractor that plays on general economic assumptions." },
            { passageIndex: 0, text: "What is the primary implication of Dr. Jian Li's statement regarding the AR training institute and the 'Centre of Excellence' designation?", options: ["Brentworth currently lacks the necessary prestige to attract skilled AR professionals.", "The hub aims to become self-sufficient in talent development and achieve recognized leadership status.", "Silverdale is actively preventing Brentworth from gaining international recognition.", "The main purpose of the training institute is to address public unfamiliarity with AR."], correctAnswer: "B", explanation: "B (Correct): Establishing an 'accredited AR training institute' implies a goal of developing talent locally (self-sufficiency). Aiming for a 'Centre of Excellence' designation while acknowledging Silverdale's 'significant prestige' suggests a desire to achieve a similar or superior recognized leadership status.\nA (Incorrect): The passage states Brentworth is 'attracting talent... worldwide.' While the institute will help, the statement doesn't imply a current lack of ability to attract talent, but rather a strategic move for future growth and recognition.\nC (Incorrect): There's no information in the passage to suggest Silverdale is actively obstructing Brentworth. Dr. Li acknowledges Silverdale's prestige, which is a benchmark, not an act of hostility.\nD (Incorrect): While public unfamiliarity is mentioned as 'a further hurdle' in the next sentence, Dr. Li's quoted statement focuses on the institute and excellence designation. The training institute would likely help with public familiarity as a secondary benefit, but his stated aims are talent development and recognition. This tests careful reading of distinct ideas." },
            { passageIndex: 0, text: "The author's overall tone regarding the Brentworth Quarter's transformation can best be described as:", options: ["Critically analytical, questioning the long-term viability of the AR hub.", "Cautiously optimistic, acknowledging success but highlighting overwhelming future risks.", "Objectively informative, presenting facts without discernible positive or negative bias.", "Largely positive and admiring of the initiative's success and future aspirations."], correctAnswer: "D", explanation: "D (Correct): The passage uses phrases like 'saw potential,' 'initiative persevered,' 'global leader,' 'attracting talent and investment,' 'transformation has not only created thousands of high-skilled jobs but has also reversed the population decline,' and frames future goals positively. This indicates an admiring and positive stance.\nA (Incorrect): There is no language suggesting a critical analysis of long-term viability; challenges are mentioned as things to overcome, not as fundamental flaws.\nB (Incorrect): While hurdles are mentioned (public unfamiliarity), the overall tone isn't dominated by 'overwhelming future risks.' The success is presented more strongly than the caution.\nC (Incorrect): While informative, the choice of words and the narrative of overcoming adversity to achieve success (e.g., 'it worked' in the model passage style, implied here by 'persevered' leading to 'global leader') suggest more than just neutral fact presentation. There's a clear positive framing." },
            
            // Questions for New Passage 2: Ecological Management
            { passageIndex: 1, text: "According to the passage, 'precautionary inaction' becomes problematic when:", options: ["It is based on a desire to avoid repeating any past intervention mistakes.", "The delay in action leads to significantly more challenging or costly remediation.", "Authorities lack the resources for immediate, wide-scale intervention.", "It prioritizes data collection over the concerns of environmental activists."], correctAnswer: "B", explanation: "B (Correct): The passage states that with precautionary inaction, 'the ecosystem rapidly deteriorates, a critical tipping point is crossed, and recovery becomes vastly more expensive and uncertain. The manager has made an error... where the cost of inaction outweighed the initial risk.' This directly links the problem to more difficult/costly recovery due to delay.\nA (Incorrect): While being 'wary of past interventions that proved harmful' is the motivation for precautionary inaction, this wariness itself isn't what makes it problematic. It becomes problematic due to its consequences.\nC (Incorrect): The passage doesn't mention lack of resources as the reason for the manager's inaction in the first example; it's a deliberate choice to wait for more data. This is a plausible real-world distractor but not supported by the text's definition.\nD (Incorrect): The passage doesn't frame precautionary inaction in terms of a conflict between data and activists in its initial definition. The final paragraph mentions activists in a different context of potential misassessment." },
            { passageIndex: 1, text: "The author implies that effective environmental stewardship primarily requires:", options: ["Prioritizing immediate action whenever a potential threat is identified.", "A willingness to accept a certain level of environmental degradation as natural.", "A nuanced judgment in assessing risks and the appropriate scale of response.", "Deferring to scientific consensus over activist demands in all situations."], correctAnswer: "C", explanation: "C (Correct): The final paragraph states, 'Learning to differentiate between genuine threats... and minor fluctuations... is critical... It involves balancing the risk of doing too little against the risk of doing too much.' This directly points to nuanced judgment and appropriate scaling of response.\nA (Incorrect): This describes the error of 'over-intervention' if the threat isn't genuine or the action is disproportionate. The passage cautions against this.\nB (Incorrect): The passage discusses managing stress and deterioration, implying a goal of mitigation, not passive acceptance of degradation. 'Natural variation' is mentioned as something that shouldn't be a default dismissal of early warnings.\nD (Incorrect): While the passage gives an example of an activist potentially 'failing to accurately assess,' it also gives an example of a scientist doing the same. It doesn't advocate for deferring to one group over another in all situations but emphasizes accurate assessment by anyone involved." },
            { passageIndex: 1, text: "Which of the following scenarios, if true, would be an example of 'over-intervention' as described in the passage?", options: ["A city invests in reinforcing its sea walls after climate models predict a significant rise in sea levels over 50 years.", "Following a single unconfirmed report of a rare bird in a development zone, all construction is halted indefinitely.", "Farmers reduce pesticide use after studies show a minor, localized decline in a common insect species.", "A community starts a water conservation program during a prolonged and severe drought."], correctAnswer: "B", explanation: "B (Correct): 'Over-intervention' is an 'action taken was disproportionate to the actual threat, leading to unintended negative consequences.' Halting all construction indefinitely based on a single unconfirmed report is a disproportionate response to an unverified and potentially minor issue, with significant (implied) negative economic consequences.\nA (Incorrect): Reinforcing sea walls based on predictive climate models is a proactive measure against a potentially significant future threat; it's not necessarily disproportionate, especially if models are robust. This is more like a measured intervention.\nC (Incorrect): Reducing pesticide use due to a minor decline is a measured, cautious response, more akin to careful management than over-intervention.\nD (Incorrect): Water conservation during a severe drought is a necessary and proportionate response to a clear and present threat." },
            { passageIndex: 1, text: "The author's primary purpose in this passage is to:", options: ["Advocate for stricter regulations on environmental interventions.", "Critique the indecisiveness of resource managers in coastal ecosystems.", "Explain two types of decision-making errors in environmental management and stress the need for balance.", "Persuade scientists and activists to collaborate more effectively on environmental issues."], correctAnswer: "C", explanation: "C (Correct): The passage clearly defines 'precautionary inaction' and 'over-intervention' with examples (explaining two error types) and concludes by emphasizing the importance of 'balancing the risk' and accurately assessing situations (stressing the need for balance).\nA (Incorrect): The passage discusses the outcomes of decisions, not the need for stricter regulations per se. It's about the judgment process itself.\nB (Incorrect): While the first example features a resource manager making an error, the passage is broader, also discussing authorities and giving examples of scientists and activists. It's not a focused critique of one group.\nD (Incorrect): While the final paragraph mentions scientists and activists, the main thrust of the passage is not about their collaboration but about the general principles of avoiding under-response and over-response for anyone involved in environmental stewardship. This is a secondary inference, not the primary purpose." },
            
            // Questions for New Passage 3: Dr. Thorne & Dr. Hanson - Chroniton Particle Theory
            { passageIndex: 2, text: "The passage suggests that the initial collaboration between Thorne and Hanson was characterized by:", options: ["Immediate recognition and support from the wider scientific community.", "Hanson taking the lead in developing the foundational theoretical concepts.", "Overcoming external doubts through a persistent, mutually beneficial partnership.", "A primary focus on cosmological models rather than particle physics."], correctAnswer: "C", explanation: "C (Correct): The passage states their initial correspondence 'was met with scepticism by the broader physics community, they began a fruitful, if sometimes remote, collaboration.' This implies they overcame external doubts ('scepticism') through their persistent ('spanned decades,' 'fruitful') partnership. The mutual benefit is shown by Thorne's theories guiding Hanson's experiments, and Hanson's data validating Thorne.\nA (Incorrect): This is directly contradicted by 'met with scepticism by the broader physics community.'\nB (Incorrect): Thorne published the 'speculative paper on temporal energy fields' that caught Hanson's attention, and he provided 'foundational mathematical frameworks' and 'critical theoretical guidance.' Hanson was the experimentalist.\nD (Incorrect): Their initial collaboration was on 'temporal energy fields' and 'anomalous data from her particle collision experiments,' leading to the 'chroniton particle theory.' Thorne focused on cosmology later, during a period of 'divergence.'" },
            { passageIndex: 2, text: "What can be inferred about Dr. Thorne's primary role in the major experimental projects like the 'Chronos Array'?", options: ["He was responsible for the day-to-day management and operational oversight of the experiments.", "His involvement was minimal once his initial theoretical papers were published.", "He provided the essential conceptual and mathematical direction that underpinned the experimental design.", "He secured most of the funding and international support for these large-scale projects."], correctAnswer: "C", explanation: "C (Correct): The passage states, 'Thorne rarely engaged in direct experimental oversight but provided critical theoretical guidance for Hanson's large-scale projects.' Hanson also says, 'His theoretical insights were the map.' This points to his role as providing the conceptual and mathematical direction.\nA (Incorrect): This is contradicted by 'rarely engaged in direct experimental oversight.'\nB (Incorrect): The passage mentions his 'revised chroniton equations' in 1978 were crucial for the resumed intensive collaboration, and he provided 'critical theoretical guidance for Hanson's large-scale projects' in the 1980s, well after his initial 1958 paper.\nD (Incorrect): The passage doesn't provide information about who secured funding. While plausible for a leading scientist, it's not stated or implied about Thorne specifically." },
            { passageIndex: 2, text: "The 'periods of divergence' between 1969 and 1973 suggest that Thorne and Hanson:", options: ["Had a fundamental disagreement that temporarily halted their collaboration on chronitons.", "Independently pursued specialized research interests that later proved complementary.", "Competed to achieve breakthroughs in different areas of particle physics.", "Paused their joint work due to a lack of significant experimental results at the time."], correctAnswer: "B", explanation: "B (Correct): During this period, 'Thorne focused on cosmological models' and Hanson was 'refining detection methods for ephemeral particles.' These are different specializations. Their collaboration 'resumed intensively' later when Hanson's findings matched Thorne's revised equations, implying their independent work could still connect and be complementary.\nA (Incorrect): The passage doesn't mention any disagreement. It simply states they 'focused on' different areas.\nC (Incorrect): There's no mention of competition. They pursued different lines of inquiry.\nD (Incorrect): The passage doesn't state a lack of results as the cause. It describes them actively working on different projects. Hanson was 'refining detection methods,' which implies ongoing work." },
            { passageIndex: 2, text: "Hanson's quote, 'His theoretical insights were the map,' primarily emphasizes:", options: ["The navigational challenges faced by experimental physicists in new research frontiers.", "Thorne's ability to predict the exact outcomes of her experiments.", "The indispensable guiding framework Thorne's theories provided for her empirical investigations.", "The visual and schematic nature of Thorne's mathematical equations."], correctAnswer: "C", explanation: "C (Correct): A 'map' in this context is a guide that shows the way, provides direction, and helps navigate complex terrain. This directly relates to Thorne's theories providing the 'indispensable guiding framework' for Hanson's experimental work ('searching in the dark' without it).\nA (Incorrect): While true that new research has challenges, the quote is specifically about the solution or aid Thorne provided, not just the problem.\nB (Incorrect): A map guides, it doesn't necessarily tell you exactly what you'll find at every single point with absolute certainty before you get there. 'Guiding framework' is more accurate than 'predict the exact outcomes.' Prediction is part of it, but 'map' implies a broader guidance.\nD (Incorrect): 'Map' is used metaphorically here to describe the function and utility of his insights, not the literal format of his equations. This is a too-literal interpretation of the metaphor." },
            
            // Questions for New Passage 4: Hospital Director's Speech - Healthcare Reform
            { passageIndex: 3, text: "The speaker implies that the 'true strength' of the caregivers is most evident when:", options: ["New medical technologies and protocols are successfully implemented.", "They adhere strictly to their professional code of ethics during routine operations.", "External pressures and resource limitations test their fundamental commitment.", "The hospital receives positive feedback from the community for its services."], correctAnswer: "C", explanation: "C (Correct): The speaker says, 'Yet, it is in times of systemic pressure, when resources are strained and the path forward seems uncertain, that our true strength is revealed... because We, the caregivers, remain committed to the core principles...' This directly links the revelation of true strength to situations of external pressure and resource limitations testing their commitment.\nA (Incorrect): The speaker explicitly states true strength is revealed 'not solely through advanced technology or new protocols,' suggesting these are secondary to commitment in this context.\nB (Incorrect): While adherence to ethics is part of their commitment, the speaker emphasizes this strength is revealed specifically 'in times of systemic pressure,' not just during routine operations.\nD (Incorrect): Community trust is mentioned as something the speaker is mindful of, but the revelation of 'true strength' is framed as an internal quality tested by adversity, not by external validation." },
            { passageIndex: 3, text: "According to the speaker, the 'erosion of morale' is particularly dangerous because it:", options: ["Directly leads to increased operational costs and staff shortages.", "Is more difficult to address than tangible pressures like waiting lists.", "Threatens the caregivers' ambition and resolve in providing quality patient care.", "Is primarily caused by a lack of recognition from hospital management."], correctAnswer: "C", explanation: "C (Correct): The speaker describes the erosion of morale as 'a weariness that whispers of insurmountable obstacles, that suggests we must temper our aspirations for patient care.' This directly links it to a threat against their ambition and resolve for quality care.\nA (Incorrect): The passage lists escalating operational costs and staff shortages as 'tangible pressures' that contribute to the crisis, but doesn't state that eroding morale directly causes these specific tangible issues. The relationship is more that all these factors are part of the crisis, and morale is an additional dangerous element.\nB (Incorrect): The speaker calls it 'Less quantifiable, but equally significant,' not necessarily more difficult to address. The danger lies in its impact on aspirations.\nD (Incorrect): The passage doesn't mention a lack of recognition from management as a cause for eroding morale. The causes are implied to be the broader systemic pressures and challenges." },
            { passageIndex: 3, text: "When the speaker says, 'In this moment, we choose resilience over resignation, collaborative innovation over siloed efforts,' they are primarily aiming to:", options: ["Announce a new set of mandatory operational guidelines for all staff.", "Criticize past approaches that relied too heavily on individual efforts.", "Inspire a proactive and unified mindset among the staff to confront challenges.", "Promise an immediate solution to the ongoing healthcare crisis."], correctAnswer: "C", explanation: "C (Correct): The phrasing 'we choose' and the contrasting of positive approaches (resilience, collaborative innovation) with negative ones (resignation, siloed efforts) is classic rhetorical language aimed at inspiring a particular mindset and encouraging unified, proactive action.\nA (Incorrect): This is a call to a mindset or approach, not an announcement of specific guidelines. The language is too broad and inspirational for that.\nB (Incorrect): While 'siloed efforts' implies a past issue, the primary aim of this specific phrase is forward-looking and motivational, not a direct critique of the past. The focus is on the choice being made now.\nD (Incorrect): The speaker explicitly states the challenges 'will not be overcome swiftly, nor without significant effort,' which contradicts the idea of promising an immediate solution." },
            { passageIndex: 3, text: "What is the underlying message the speaker wishes to convey about the current healthcare crisis?", options: ["The crisis is largely a result of outdated ethical principles in modern medicine.", "While severe and multifaceted, the crisis can be navigated through collective resolve and innovation.", "The primary responsibility for resolving the crisis lies with external policymakers and funders.", "The current challenges are unprecedented and may require a permanent reduction in service aspirations."], correctAnswer: "B", explanation: "B (Correct): The speaker acknowledges the crisis is 'profound,' 'immense,' and 'complex' (severe and multifaceted). However, the latter part of the speech focuses heavily on how 'they will be addressed,' the choice of 'resilience,' 'collaborative innovation,' and commitment to 'excellence' (collective resolve and innovation). This combination conveys that despite the severity, there's a path forward.\nA (Incorrect): The speaker upholds the 'core principles of healing and compassion, enshrined in our professional ethics' as a source of strength, not a cause of the crisis.\nC (Incorrect): While systemic issues are acknowledged, the speech focuses on what 'We, the caregivers' can and must do – 'our utmost ingenuity,' 'we choose.' It's a call for internal agency, not primarily a deferral of responsibility.\nD (Incorrect): The speaker explicitly pushes back against the idea of tempering aspirations: '...a weariness... that suggests we must temper our aspirations for patient care. Today I say to you: the challenges... will be met.' This directly contradicts the idea of a permanent reduction in aspirations." }
        ];


        // --- State ---
        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let timerInterval;
        let timeLeft = 10 * 60; // 10 minutes in seconds for 16 questions
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = new Array(questions.length).fill(0);
        let flaggedQuestions = new Array(questions.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPassageIndex = -1;


        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button'); 
        const endExamButtonFooter = document.getElementById('end-exam-button-footer'); 
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const passageNumberEl = document.getElementById('passage-number');
        const passageTextEl = document.getElementById('passage-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsGridContainer = document.getElementById('results-grid-container'); 
        const nameInput = document.getElementById('name');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');



        // --- Functions ---

        function startTimer() {
            examStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300'); 
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endExamAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            examEndTime = examEndTime || new Date(); 
            timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            timerEl.classList.add('text-gray-300'); 
        }

        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0; 
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

        
        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent; 
            }
            questionStartTime = null; 
        }

        
        function toggleFlag() {
            if (isReviewingFromResults) return; 
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons(); 
        }

        
        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }


        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questions.length) return;

             
             if (!isReviewingFromResults && !reviewMode) { 
                 recordTimeSpent(currentQuestionIndex);
            }

            const question = questions[index];
            const newPassageIndex = question.passageIndex;
            const passageContainer = document.querySelector('.passage-column');
            const questionContainer = document.querySelector('.question-column');

            
            if (newPassageIndex !== currentlyDisplayedPassageIndex || reviewMode) {
                passageTextEl.innerHTML = passages[newPassageIndex].replace(/\n/g, '<br><br>');
                passageNumberEl.textContent = newPassageIndex + 1;
                currentlyDisplayedPassageIndex = newPassageIndex;
                 if (passageContainer) passageContainer.scrollTop = 0; 
            }

            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode; 

            questionNumberEl.textContent = index + 1;
            questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`;
            questionTextEl.textContent = question.text;
             if (questionContainer) questionContainer.scrollTop = 0; 

            optionsContainer.innerHTML = '';
            reviewExplanationContainer.innerHTML = ''; 
            const optionLetters = ['A', 'B', 'C', 'D', 'E']; 
            question.options.forEach((option, i) => {
                const optionId = `q${index}_opt${i}`;
                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.classList.add('option-label'); // Styles for this are in CSS, including text color and size
                label.dataset.optionIndex = i; 

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.id = optionId;
                radio.name = `question_${index}`;
                radio.value = optionLetters[i]; 
                radio.disabled = reviewMode; 

                
                label.classList.remove('border-green-500', 'border-red-500', 'border-2', 'bg-green-50', 'bg-red-50', 'selected-answer');
                label.style.cursor = reviewMode ? 'default' : 'pointer';


                if (userAnswers[index] === optionLetters[i]) {
                    radio.checked = true;
                    label.classList.add('selected-answer');
                }

                
                if (reviewMode) {
                    const isCorrectAnswer = question.correctAnswer === optionLetters[i];
                    const isSelectedAnswer = userAnswers[index] === optionLetters[i];

                    if (isCorrectAnswer) {
                        label.classList.add('border-green-500', 'border-2'); 
                        if (!isSelectedAnswer) label.classList.add('bg-green-50'); 
                    } else if (isSelectedAnswer) { 
                        label.classList.add('border-red-500', 'border-2', 'bg-red-50');
                    }
                }

                label.appendChild(radio);
                const textNode = document.createTextNode(`${optionLetters[i]}) ${option}`);
                label.appendChild(textNode);

                if (!reviewMode) {
                    label.addEventListener('click', (e) => {
                        
                        if (e.target.tagName !== 'INPUT') {
                            handleOptionSelect(index, i, optionLetters[i]);
                        }
                    });
                    radio.addEventListener('change', () => handleOptionSelect(index, i, optionLetters[i]));
                }
                optionsContainer.appendChild(label);
            });

            
            if (reviewMode && question.explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.classList.add('explanation-box'); 
                explanationDiv.innerHTML = `<strong class="font-semibold">Explanation:</strong> ${question.explanation.replace(/\n/g, '<br>')}`; 
                reviewExplanationContainer.appendChild(explanationDiv);
            }
            


            prevButton.disabled = index === 0;
            if (!reviewMode && index === questions.length - 1) { 
                 nextButton.textContent = 'Finish & Review';
                 nextButton.disabled = false;
            } else if (!reviewMode) { 
                 nextButton.textContent = 'Next (Alt+N) →';
                 nextButton.disabled = false;
            } else { 
                 nextButton.disabled = index === questions.length - 1;
                 if (!nextButton.disabled) nextButton.textContent = 'Next →'; 
            }

            updateFlagButtonAppearance();

            
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endExamButtonFooter.classList.add('hidden');
                examTitleEl.textContent = "Reviewing Question";
                prevButton.disabled = index === 0; 
                navigatorButton.disabled = false; 
                flagButton.disabled = true; 
            } else { 
                backToResultsButton.classList.add('hidden');
                endExamButtonFooter.classList.remove('hidden');
                examTitleEl.textContent = "Verbal Reasoning";
                navigatorButton.disabled = false;
                flagButton.disabled = false;
                prevButton.disabled = index === 0;
            }

            updateNavigatorHighlight(); 

            
            if (!isReviewingFromResults) { 
                questionStartTime = Date.now();
            }
        }

         function handleOptionSelect(questionIndex, optionIndex, optionValue) {
             
             if (questionIndex !== currentQuestionIndex || isReviewingFromResults) return;
             userAnswers[questionIndex] = optionValue;

             
             document.querySelectorAll(`#options-container .option-label`).forEach(lbl => {
                 lbl.classList.remove('selected-answer');
                 const radio = lbl.querySelector('input[type="radio"]');
                 if(radio) radio.checked = false; 
             });

             const selectedLabel = document.querySelector(`#options-container label[for="q${questionIndex}_opt${optionIndex}"]`);
              if (selectedLabel) {
                 selectedLabel.classList.add('selected-answer');
                 const radio = selectedLabel.querySelector('input[type="radio"]');
                 if (radio) radio.checked = true; 
             }
             updateNavigatorButtons(); 
         }


        function showNextQuestion() {
            if (isReviewingFromResults) { 
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true); 
                }
            }
            else if (!isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 if (currentQuestionIndex === questions.length - 1) { 
                     stopTimer(); 
                     showReviewScreen(); 
                 } else if (currentQuestionIndex < questions.length - 1) {
                     loadQuestion(currentQuestionIndex + 1); 
                 }
            }
        }


        function showPrevQuestion() {
             if (isReviewingFromResults) { 
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true); 
                 }
             }
            else if (currentQuestionIndex > 0 && !isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            setupScreen.classList.remove('hidden');
            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
            
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = questions.length;
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `${Math.floor(timeLeft / 60)} minutes`;

        }

        function showExamScreen() {
            setupScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            examScreen.classList.add('flex'); 
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
        }


        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            reviewGrid.innerHTML = ''; 
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) { 
                     return;
                 }

                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button'; 

                if (userAnswers[index] !== null && userAnswers[index] !== undefined) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }

                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged'); 
                }

                button.onclick = () => {
                    reviewScreen.classList.add('hidden'); 
                    reviewScreen.classList.remove('flex');
                    showExamScreen(); 
                    loadQuestion(index); 
                    startTimer(); 
                };
                reviewGrid.appendChild(button);
            });

             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

         function populateNavigator() {
             navigatorGrid.innerHTML = ''; 
             questions.forEach((_, index) => {
                 const button = document.createElement('button');
                 button.textContent = index + 1;
                 
                 button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                 button.dataset.questionIndex = index; 

                 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');

                 button.onclick = () => {
                     navigatorModal.classList.remove('flex'); 
                     navigatorModal.classList.add('hidden');
                     const targetIndex = parseInt(button.dataset.questionIndex, 10);
                     
                     loadQuestion(targetIndex, isReviewingFromResults);
                     if (!isReviewingFromResults) questionStartTime = Date.now(); 
                 };
                 navigatorGrid.appendChild(button);
             });
         }

        function updateNavigatorButtons() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-answered', 'nav-current', 'nav-flagged'); 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');
             });
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            examEndTime = examEndTime || new Date(); 
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            let score = 0;
            resultsGridContainer.innerHTML = ''; 

            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                if (isCorrect) score++;

                const timeSpentMs = questionTimes[index] || 0; 
                const timeSpentSec = Math.round(timeSpentMs / 1000);

                const resultBox = document.createElement('div');
                resultBox.classList.add('result-box');
                resultBox.classList.add(isCorrect ? 'result-box-correct' : 'result-box-incorrect');
                if (flaggedQuestions[index]) {
                    resultBox.classList.add('result-box-flagged');
                }
                resultBox.dataset.index = index; 
                resultBox.title = `Click to review Question ${index + 1}`;

                const timeDiv = document.createElement('div');
                timeDiv.classList.add('time-spent');
                timeDiv.textContent = `${timeSpentSec}s`;
                resultBox.appendChild(timeDiv);

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.alignItems = 'center';
                container.appendChild(resultBox);

                const qNumDiv = document.createElement('div');
                qNumDiv.classList.add('question-num-label');
                qNumDiv.textContent = `Q${index + 1}`;
                container.appendChild(qNumDiv);
                
                container.addEventListener('click', () => {
                    revisitQuestionFromResults(index);
                });
                resultsGridContainer.appendChild(container);
            });

            scoreEl.textContent = score;
            totalQuestionsResultsEl.textContent = questions.length;
            const timeDiff = examEndTime - examStartTime;
            timeTakenEl.textContent = formatTimeDifference(timeDiff);
        }


        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showExamScreen();
            loadQuestion(index, true); 
        }

        function endExamAndShowResults() {
            stopTimer(); 
            showResultsScreen();
        }
         function handleEndExamFooterClick() {
             recordTimeSpent(currentQuestionIndex); 
             stopTimer();
             showReviewScreen(); 
         }

        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRating = focusRatingInput.value; 
            const finalScore = scoreEl.textContent;
            const totalQ = totalQuestionsResultsEl.textContent; 
            const timeTaken = timeTakenEl.textContent;

            let y = 15; 
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;
            const pageWidth = doc.internal.pageSize.width;


            
            doc.setFontSize(18);
            doc.text("UCAT Verbal Reasoning Results", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;

            
            doc.setFontSize(12);
            const summaryData = [
                ["Name:", userName || 'N/A'],
                ["Goal:", `${userGoal || 'N/A'} / ${totalQ}`],
                ["Focus Area:", userFocusArea || 'N/A'],
                ["Final Score:", `${finalScore} / ${totalQ}`],
                ["Time Taken:", timeTaken],
                ["Focus Rating (1-5):", focusRating || 'N/A']
            ];

            summaryData.forEach(row => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.setFont(undefined, 'bold');
                doc.text(row[0], margin, y);
                doc.setFont(undefined, 'normal');
                doc.text(row[1], margin + 40, y);
                y += lineHeight;
            });
            y += lineHeight; 

            
            if (y > pageHeight - margin - (lineHeight*3)) { doc.addPage(); y = margin; } 
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Main Takeaway:", margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', pageWidth - margin * 2);
            reflectionLines.forEach(line => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.text(line, margin, y);
                y += (lineHeight * 0.8);
            });
            y += lineHeight; 

            
            if (y > pageHeight - margin - (lineHeight*2)) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Detailed Results:", margin, y);
            y += lineHeight * 1.5;
            doc.setFontSize(9); 
            doc.setFont(undefined, 'normal');

            
            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                const status = isCorrect ? "Correct" : (userAnswer ? "Incorrect" : "Not Answered");
                const timeSpentSec = Math.round((questionTimes[index] || 0) / 1000);

                const questionDetails = [
                    `Q${index + 1}: ${qData.text.substring(0, 60)}...${flaggedQuestions[index] ? ' (Flagged)' : ''}`,
                    `  Your Answer: ${userAnswer || 'N/A'}`,
                    `  Correct Answer: ${correctAnswer}`,
                    `  Status: ${status}`,
                    `  Time: ${timeSpentSec}s`
                ];

                
                const blockHeight = questionDetails.length * (lineHeight * 0.75) + (qData.explanation ? 3 * (lineHeight*0.75) : 0);
                if (y + blockHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin; 
                    
                    doc.setFontSize(14); doc.setFont(undefined, 'bold');
                    doc.text("Detailed Results (Continued):", margin, y);
                    y += lineHeight * 1.5;
                    doc.setFontSize(9); doc.setFont(undefined, 'normal');
                }

                questionDetails.forEach(detailLine => {
                    doc.text(detailLine, margin, y);
                    y += (lineHeight * 0.75);
                });

                if (qData.explanation) {
                    const explLines = doc.splitTextToSize(`  Explanation: ${qData.explanation.replace(/\n/g, ' ')}`, pageWidth - (margin * 2.5)); 
                    explLines.forEach(explLine => {
                         if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                         doc.text(explLine, margin + 5, y); 
                         y += (lineHeight * 0.75);
                    });
                }
                y += (lineHeight * 0.5); 
            });

            doc.save(`ucat_vr_results_${userName.replace(/\s+/g, '_') || 'user'}.pdf`);
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            userName = nameInput.value.trim();
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();

            
            timeLeft = 10 * 60; 
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false; 
            currentlyDisplayedPassageIndex = -1; 

            showExamScreen();
            startTimer(); 
            loadQuestion(0);
            populateNavigator(); 
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults); 
        endExamButtonFooter.addEventListener('click', handleEndExamFooterClick); 
        backToResultsButton.addEventListener('click', () => {
            isReviewingFromResults = false; 
            showResultsScreen(); 
        });
        navigatorButton.addEventListener('click', () => {
             recordTimeSpent(currentQuestionIndex); 
            updateNavigatorButtons(); 
            navigatorModal.classList.remove('hidden');
            navigatorModal.classList.add('flex');
        });
        closeModalButton.addEventListener('click', () => {
             navigatorModal.classList.remove('flex');
             navigatorModal.classList.add('hidden');
             if (!isReviewingFromResults) questionStartTime = Date.now(); 
        });
        
        navigatorModal.addEventListener('click', (event) => {
            if (event.target === navigatorModal) closeModalButton.click();
        });

        flagButton.addEventListener('click', toggleFlag);

        filterFlaggedButton.addEventListener('click', () => {
            isFilteringFlagged = !isFilteringFlagged;
            showReviewScreen(isFilteringFlagged); 
        });

        
        downloadPdfButton.addEventListener('click', generatePDF);


        
        function handleKeyboardShortcuts(e) {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');

             if (isModalVisible || isInputFocused) return; 
             if (!isExamVisible) return; 

             const key = e.key.toLowerCase();
             const altOrOption = e.altKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': 
                         e.preventDefault();
                         if (!nextButton.disabled) nextButton.click();
                         return;
                     case 'keyp': 
                         e.preventDefault();
                         if (!prevButton.disabled) prevButton.click();
                         return;
                     case 'keyf': 
                         e.preventDefault();
                         if (!isReviewingFromResults && !flagButton.disabled) flagButton.click();
                         return;
                     default:
                         return; 
                 }
             } else { 
                 
                 if (['a', 'b', 'c', 'd'].includes(key) && !isReviewingFromResults) {
                     e.preventDefault();
                     const optionIndex = ['a', 'b', 'c', 'd'].indexOf(key);
                     const optionValue = ['A', 'B', 'C', 'D'][optionIndex];
                     const currentQuestionData = questions[currentQuestionIndex];
                     if (optionIndex < currentQuestionData.options.length) { 
                         handleOptionSelect(currentQuestionIndex, optionIndex, optionValue);
                     }
                     return;
                 }
             }
        }

        document.addEventListener('keydown', handleKeyboardShortcuts);


        // --- Initial Load ---
        showSetupScreen(); // Start with the setup screen

    </script>
</body>
</html>
