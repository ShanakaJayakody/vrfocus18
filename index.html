<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT VR Practice - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff; /* UPDATED: Body background to white */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); 
            width: 100%;
            background-color: #ffffff; 
            border: 1px solid #d1d5db; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; 
            margin: 1rem; 
            overflow: hidden; 
        }
        /* Header and Footer */
        .header-bar, .footer-bar {
            flex-shrink: 0; 
            background-color: #006DAA; 
            color: white; 
            padding: 0.75rem 1.5rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar span, .header-bar div {
             color: white;
        }
        #timer {
             background-color: rgba(255, 255, 255, 0.2); 
             color: white;
             font-weight: bold;
             padding: 0.25rem 0.75rem; 
             border-radius: 0.25rem; 
        }
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); 
            padding: 0.4rem 0.8rem; 
            font-size: 0.8rem; 
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); 
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         .footer-bar button#next-button {
             background-color: #ffffff; 
             color: #006DAA; 
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; 
         }
         #flag-button {
             background-color: transparent;
             border: 1px solid white;
             color: white;
             transition: background-color 0.2s ease, color 0.2s ease; 
         }
         #flag-button:hover {
             background-color: white;
             color: #006DAA;
         }
          #flag-button.flagged {
             background-color: #facc15; 
             border-color: #facc15;
             color: #422006; 
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; 
             border-color: #f59e0b;
          }

        .main-content-area {
            flex-grow: 1; 
            display: flex;
            overflow: hidden; 
            padding: 1rem; 
            gap: 1rem; 
        }
        .passage-column {
            flex: 0 0 60%; 
            overflow-y: auto; 
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #ffffff; 
            height: 100%; 
        }
        .question-column {
             flex: 0 0 40%; 
             overflow-y: auto; 
             padding: 1rem;
             border: 1px solid #e5e7eb;
             border-radius: 0.375rem;
             background-color: #ffffff; 
             height: 100%; 
             position: relative; 
        }

        .selected-answer {
            background-color: #bfdbfe !important; 
            border-color: #3b82f6 !important; 
        }
        .nav-answered {
            background-color: #a7f3d0; 
        }
        .nav-current {
            border: 2px solid #3b82f6 !important; 
            font-weight: bold;
        }
        .nav-flagged, .review-flagged {
            border: 2px solid #f59e0b !important; 
            position: relative; 
        }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        .subtle-button { background-color: #f3f4f6; color: #374151; border: 1px solid transparent; }
        .subtle-button:hover:not(:disabled) { background-color: #e5e7eb; }

        .option-label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #ffffff; 
            color: #111827; 
            font-size: 1rem;  
        }
        .option-label:hover:not(.selected-answer) { 
            background-color: #f3f4f6; 
            border-color: #a5b4fc; 
        }
        input[type="radio"] { display: none; }

       .correct-answer-li { background-color: #dcfce7; border-left: 4px solid #22c55e; }
       .incorrect-answer-li { background-color: #fee2e2; border-left: 4px solid #ef4444; }
       .result-item-clickable-li { 
           cursor: pointer;
           transition: background-color 0.2s ease-in-out;
           border: 1px solid #e5e7eb;
           border-radius: 0.5rem;
           margin-bottom: 0.5rem;
           padding: 0.75rem;
       }
       .result-item-clickable-li:hover {
           background-color: #f0f0f0;
       }
       .correct-indicator-text { color: #16a34a; font-weight: 600;}
       .incorrect-indicator-text { color: #dc2626; font-weight: 600;}

        #results-grid-container { 
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 columns */
            grid-template-rows: repeat(2, 1fr); /* 2 rows */
            gap: 0.75rem; /* Balanced spacing between boxes */
            padding: 1rem 0; 
            overflow-y: auto; 
            max-width: 100%; /* Use full width of container */
            width: 100%;
            margin: 0 auto; /* Center the grid */
        }
        .result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Keep boxes square */
            padding: 0.5rem; /* Padding for better content display */
            border-radius: 0.375rem;
            color: white; 
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.25rem;
            width: 100%;
            height: auto;
            min-width: 3rem; /* Minimum width */
        }
        .result-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .result-box-correct {
            background-color: #22c55e; 
            border: 1px solid #16a34a; 
        }
        .result-box-incorrect {
            background-color: #ef4444; 
            border: 1px solid #dc2626; 
        }
        .result-box-flagged { 
            outline: 2px solid #f59e0b; 
            outline-offset: 2px;
        }
        .result-box .time-spent {
            font-size: 1rem; /* Balanced font size */
            font-weight: 600; 
            line-height: 1.1;
        }
        .question-num-label {
            font-size: 0.75rem; /* Balanced font size */
            color: #374151;
            text-align: center;
            width: 100%;
        }
       
        /* Media queries for responsive grid */
        @media (max-width: 992px) {
            #results-grid-container {
                grid-template-columns: repeat(8, 1fr);
                max-width: 100%;
            }
        }
        @media (max-width: 768px) {
            #results-grid-container {
                grid-template-columns: repeat(4, 1fr); /* 4 columns on medium screens */
                grid-template-rows: repeat(4, 1fr); /* 4 rows on medium screens */
                max-width: 100%;
                gap: 0.5rem;
            }
        }
        @media (max-width: 480px) {
            #results-grid-container {
                grid-template-columns: repeat(4, 1fr); /* Changed from 2 to 4 columns */
                grid-template-rows: repeat(4, 1fr); /* Changed from 8 to 4 rows */
                gap: 0.4rem;
            }
            .result-box .time-spent {
                font-size: 0.85rem;
            }
        }
         .explanation-box {
             background-color: #f3f4f6; 
             border: 1px solid #d1d5db;   
             padding: 0.5rem 0.75rem; 
             margin-top: 0.75rem; 
             border-radius: 0.375rem; 
             font-size: 0.875rem; 
             color: #111827; 
         }

         .review-grid-button {
             padding: 0.5rem 0.25rem; 
             border: 1px solid #d1d5db; 
             border-radius: 0.375rem;
             text-align: center;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             font-size: 0.875rem;
             line-height: 1.25rem;
             cursor: pointer;
         }
         .review-grid-button-answered {
             background-color: #dcfce7; 
             border-color: #86efac; 
             color: #15803d; 
         }
         .review-grid-button-unanswered {
             background-color: #f3f4f6; 
             border-color: #d1d5db; 
             color: #4b5563; 
         }
          .review-grid-button:hover {
             filter: brightness(95%); 
          }

        @media (max-width: 768px) {
            #app-container {
                 height: auto; 
                 margin: 0.5rem;
            }
            .main-content-area {
                flex-direction: column; 
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .passage-column, .question-column {
                flex-basis: auto;
                width: 100%; 
                height: auto; 
                max-height: 40vh; 
                padding: 0.75rem;
            }
            .header-bar, .footer-bar {
                padding: 0.5rem 1rem;
            }
            .header-bar span, .footer-bar button { 
                font-size: 0.8rem;
            }
            button, .button {
                padding: 0.4rem 0.8rem;
            }
             .footer-bar button {
                 padding: 0.3rem 0.6rem;
                 font-size: 0.75rem;
             }
            .grid-cols-5 { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            /* #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); } REMOVED to keep 8 columns */
        }
         @media (max-width: 480px) {
             .grid-cols-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); } 
             #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
             .header-bar span, .footer-bar button { font-size: 0.75rem; }
             button, .button {
                 padding: 0.3rem 0.6rem;
             }
              .footer-bar button {
                 padding: 0.25rem 0.5rem;
                 font-size: 0.7rem;
             }
             .option-label { padding: 0.5rem 0.75rem; font-size: 0.875rem;} 
             .review-grid-button { font-size: 0.75rem; }
             /* #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); } REMOVED to keep 8 columns */
         }
         /* UPDATED: Media queries for result box text on smaller screens with 8 columns */
        @media (max-width: 600px) { 
            #results-grid-container {
                gap: 0.25rem; /* Further reduce gap for small screens */
            }
            .result-box .time-spent {
                font-size: 0.875rem; /* text-sm */
            }
            .result-box .question-num-label {
                font-size: 0.6rem; 
            }
        }
        @media (max-width: 400px) { 
            .result-box .time-spent {
                font-size: 0.75rem; /* text-xs */
            }
            .result-box .question-num-label {
                font-size: 0.5rem; 
            }
             .result-box {
                padding: 0.1rem; /* Minimal padding for very small squares */
             }
        }


    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>

    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-20 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">UCAT Verbal Reasoning Practice</h1> <p class="text-gray-900 mt-2">Prepare for the UCAT VR section.</p> <p class="text-sm text-gray-900 mt-4"> This section contains <strong id="setup-question-count">16 questions</strong> and you have <strong id="setup-time-limit">10 minutes</strong> to complete it.
                </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-900">Name:</label> <input type="text" id="name" name="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter your name">
                </div>
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-900">Goal (Score out of 16):</label> <input type="number" id="goal" name="goal" min="0" max="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 12">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-gray-900">Area of Focus / Intention For Practice:</label> <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., True/False/Can't Tell, Speed">
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="start-button" class="primary-button text-lg px-8 py-3">
                    Start Exam
                </button>
            </div>
        </div>

        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Verbal Reasoning</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="text-base px-3 py-1 rounded-md">10:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 16</span>
                    <button id="flag-button" class="text-sm font-medium border border-white rounded px-2 py-1 transition-colors duration-150">
                         Flag for Review
                    </button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="passage-column">
                    <h3 class="text-lg font-semibold mb-2 sticky top-0 bg-white text-gray-900 pb-1">Passage <span id="passage-number">1</span></h3>
                    <div id="passage-text" class="text-base text-gray-900 leading-relaxed whitespace-pre-wrap">
                        </div>
                </div>

                <div class="question-column">
                     <h4 class="text-md font-semibold mb-3 sticky top-0 bg-white text-gray-900 pb-1">Question <span id="question-number">1</span></h4>
                    <p id="question-text" class="mb-4 text-gray-900 text-base">
                        </p>
                    <div id="options-container" class="space-y-2">
                        </div>
                    <div id="review-explanation-container"></div>
                </div>
            </div>

            <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-exam-button-footer">End Exam</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-gray-900">Review Your Answers</h2> <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-900 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p> <div id="review-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-10 gap-3 mb-6 w-full max-w-3xl">
                </div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="danger-button text-lg px-8 py-3">
                    End Exam & See Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-16 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                 <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Exam Results</h2> </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0 text-gray-900"> <p class="text-lg font-semibold">Your Score: <span id="score" class="text-gray-900">0</span> / <span id="total-questions-results">16</span></p> <p>Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="text-xl font-semibold mb-2 flex-shrink-0 text-gray-900">Detailed Results:</h3> <p class="text-sm text-gray-900 mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-grid-container">
                </div>
            <div class="mt-6 flex-shrink-0 border-t pt-4">
                 <div class="mb-4">
                    <label for="focus-rating" class="block text-md font-semibold text-gray-900 mb-1">My focus out of 5 (1 very low, 5 very high):</label> <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-900 mb-1">Main takeaway from this practice:</label> <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
             <div class="mt-6 text-center flex-shrink-0 flex justify-center space-x-4">
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2">
                    Try Again
                </button>
                <button id="download-pdf-button" class="primary-button px-6 py-2">
                    Download Results PDF
                </button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">Question Navigator</h3> <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-900 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p> <div id="navigator-grid" class="grid grid-cols-5 gap-3">
                    </div>
            </div>
        </div>

    </div>

    <script>
        // --- Data ---
        const passages = [
            // Passage 1: Ronald Fisher - Correlation vs Causation (from PDF page 5)
            `In 1938, British statistician Ronald Fisher responded dismissively to a new idea put forward by a younger colleague: that smoking might be linked to lung cancer. At the time, Fisher was a giant of statistical theory, having developed much of the framework for hypothesis testing and experimental design. He argued that correlation did not imply causation and that genetic predisposition could easily account for the link. Ironically, his own methods would later be used to establish the very link he had denied.\nToday, the tension Fisher highlighted-between correlation and causation-remains central in the age of machine learning. Algorithms trained on massive datasets may detect subtle patterns, but their decisions often rest on statistical associations, not mechanistic understanding. A medical Al might "learn" that patients wearing hospital gowns are more likely to be diagnosed with severe illness-not because the gown causes the illness, but because the context is confounded.\nIn response, a subfield of data science has emerged: causal inference. Drawing from counterfactual reasoning and graph theory, researchers like Judea Pearl argue that prediction without causation is like surgery without anatomy: effective only by luck. Yet critics counter that such frameworks still rely on human-chosen models, making objectivity elusive.\nFisher's legacy thus endures in an unexpected way. While his stance on tobacco was wrong, his insistence on careful causal reasoning now underpins some of the most pressing debates in science. The challenge today is not simply to ask "What predicts what?", but rather "What, if anything, causes what to happen?"`,
            // Passage 2: Werner Heisenberg - Uncertainty Principle (from PDF page 9)
            `In 1927, Werner Heisenberg formalised a now-famous idea: that the more precisely we measure a particle's position, the less precisely we can know its momentum. This wasn't a limitation of technology but a feature of reality itself-a claim that challenged Newtonian ideals of objectivity. The Uncertainty Principle, as it became known, didn't just change physics; it called into question the very nature of knowledge.\nFast forward to today, and uncertainty is once again at the centre of physics-not in the quantum domain, but in climate science. Earth system models, built on thermodynamics and fluid dynamics, forecast global temperature trends decades ahead. But they rely on complex inputs-emission pathways, feedback loops, human behavior-that resist tidy formulation. In fact, when the Intergovernmental Panel on Climate Change (IPCC) publishes projections, it does so not with single figures, but with probability ranges, confidence levels, and carefully worded caveats.\nThis echoes a deeper tension: the desire for predictive certainty in a world that seems increasingly probabilistic. Some scientists argue that uncertainty must be communicated more boldly-as a form of intellectual humility. Others worry that doing so fuels skepticism or inaction, especially when public policy demands clear guidance. The paradox is sharp: a model that admits uncertainty might be more trustworthy, not less-yet may appear weaker in the eyes of decision-makers.\nAnd so, as in Heisenberg's time, we are faced with the epistemological dilemma of acting amid ambiguity. The challenge is not simply to reduce uncertainty, but to understand what kind of truth can be claimed and what kinds cannot-when knowledge itself is both informed and constrained by the frameworks we choose to use.`,
            // Passage 3: Partition of British India (from PDF page 13)
            `The partition of British India in 1947 was not merely a response to religious discord but a culmination of colonial strategies that had long reinforced division. Rather than a spontaneous eruption of sectarian strife, the formation of India and Pakistan emerged from decades of British administrative choices. The Morley-Minto Reforms of 1909, for example, introduced separate electorates for Muslims-cementing religious identity within political representation. This institutional distinction expanded with the Government of India Act in 1935, which allocated half of provincial seats to communal electorates, embedding religious separateness into governance.\nBy the end of World War II, Britain's imperial fatigue and domestic pressures demanded a rapid disengagement. Between 1945 and 1947, the number of British troops stationed in India fell by more than 60%, reflecting the logistical limits of maintaining order. Lord Mountbatten, arriving as the last Viceroy in March 1947, initially envisioned a withdrawal by mid-1948, but riots such as the Direct Action Day in Calcutta-where over 4,000 people died-forced the timeline to contract. The division of British India into two nations was implemented within five months.\nSir Cyril Radcliffe, charged with drawing the borders, had never been to India, lacked local knowledge, and was given outdated maps and incomplete census data. Despite this, he was expected to deliver the boundary in just five weeks. The resulting Radcliffe Line split communities, properties, and even families.\nAn estimated 14 million people were displaced, with Punjab witnessing the most dramatic upheaval: roughly 75% of its Muslims migrated to Pakistan, while nearly six million Hindus and Sikhs fled in the opposite direction. The death toll from this period remains contested, ranging from 200,000 to over two million.\nPartition was not simply a political reshuffle. It forcibly redefined identity, land, and memory. Though presented as a solution, it was in many ways an accelerated conclusion to a longer imperial logic: divide, govern, and retreat.`,
            // Passage 4: Attention Economy (from PDF page 17)
            `In the digital age, attention is not simply a cognitive resource it is currency. Social media platforms, mobile games, and streaming services are engineered to maximise user engagement, often by exploiting psychological triggers like intermittent rewards and variable schedules. As users spend more time within these platforms, advertisers gain more impressions, and the platforms become more profitable.\nHowever, the mechanics of this attention economy have raised concerns. Some behavioural scientists argue that apps are not merely reflecting user interest but actively shaping it. Techniques such as infinite scroll, push notifications, and personalised recommendations are designed not only to serve content but to keep users in a continuous loop of consumption. Critics contend this architecture is manipulative, encouraging compulsive use rather than genuine exploration.\nProponents of the system, however, argue that algorithmic curation allows for more efficient discovery. A reader might encounter books they would never have searched for, or a musician might find a global audience. In this view, digital systems expand, rather than narrow, user agency if used intentionally.\nStill, the question remains whether users are primarily choosing or being chosen for. A 2022 study by the Institute for Media Ethics found that over 70% of users believed they had control over their content feed, while over 60% of their interactions could be predicted by platform algorithms. Whether this discrepancy is cause for concern or simply a feature of modern life remains a matter of debate.`
        ];

        const questions = [
            // Questions for Passage 1: Ronald Fisher
            { passageIndex: 0, text: "Which of the following best captures the central insight of the passage?", options: ["Advances in Al have reduced the need for traditional causal thinking.", "The conflict between correlation and causation continues to shape statistical reasoning.", "Ronald Fisher's work was foundational, although many of his conclusions were later disproven.", "Most modern machine learning systems are based on counterfactual frameworks."], correctAnswer: "B", explanation: "B (Correct): The passage states 'Today, the tension Fisher highlighted-between correlation and causation-remains central in the age of machine learning' [cite: 9] and concludes that 'his insistence on careful causal reasoning now underpins some of the most pressing debates in science.' [cite: 15] This points to the ongoing relevance of this conflict. \nA (Incorrect): The passage suggests the opposite; the rise of AI and machine learning has made the distinction between correlation and causation even more critical, as algorithms might rely on spurious correlations (e.g., the hospital gown example [cite: 11]). \nC (Incorrect): While his stance on tobacco was wrong[cite: 15], the passage emphasizes that his methods were foundational [cite: 6] and his insistence on causal reasoning endures[cite: 15]. It doesn't say 'many' of his conclusions were disproven, rather highlights a specific instance where he was wrong but his broader concerns about causality remain relevant. \nD (Incorrect): The passage mentions causal inference draws from counterfactual reasoning and graph theory[cite: 13], but also notes critics argue these 'still rely on human-chosen models, making objectivity elusive.' [cite: 14] It does not state that 'most' modern ML systems are based on these, nor that they are without critique." },
            { passageIndex: 0, text: "Why is the anecdote about hospital gowns included in the passage?", options: ["To show that machine learning algorithms can detect causal mechanisms.", "To illustrate how spurious correlations can arise in data-driven models.", "To argue that algorithms are superior to human judgment in medicine.", "To support the idea that machine learning always requires human supervision."], correctAnswer: "B", explanation: "B (Correct): The passage explains that a medical AI might learn that patients in gowns are more likely to be severely ill, 'not because the gown causes the illness, but because the context is confounded.' [cite: 11] This is a direct example of a statistical association (correlation) that does not imply causation, i.e., a spurious correlation. \nA (Incorrect): The example illustrates the opposite; the AI detects a correlation, not a causal mechanism[cite: 11]. \nC (Incorrect): The example is used to highlight a potential pitfall of AI, not to argue for its superiority in this context. \nD (Incorrect): While this might be an implication one could draw, the primary purpose of the anecdote is more specific: to illustrate the problem of spurious correlations in AI[cite: 11], which relates directly to the theme of correlation vs. causation." },
            { passageIndex: 0, text: "Which assumption does the author make about Judea Pearl's view of data science?", options: ["That causal frameworks are the only way to ensure fair decision-making in Al.", "That Pearl's approach addresses a shortcoming in traditional statistical modeling.", "That counterfactual reasoning has conclusively replaced correlation analysis.", "That graph theory eliminates all ambiguity from model selection."], correctAnswer: "B", explanation: "B (Correct): The passage introduces causal inference and Judea Pearl's work 'In response' to algorithms resting on statistical associations without mechanistic understanding[cite: 10, 12]. Pearl's argument that 'prediction without causation is like surgery without anatomy: effective only by luck' [cite: 13] clearly implies he sees a shortcoming (lack of causal understanding) in models that rely purely on prediction/correlation. \nA (Incorrect): The passage doesn't mention fairness in relation to Pearl's views, nor does it suggest causal frameworks are the *only* way for any specific goal. \nC (Incorrect): The passage presents causal inference as an emerging subfield [cite: 12] and notes ongoing debates and critics[cite: 14]; it does not suggest replacement. \nD (Incorrect): The passage states that critics counter that causal frameworks 'still rely on human-chosen models, making objectivity elusive,' [cite: 14] which implies ambiguity is not eliminated." },
            { passageIndex: 0, text: "What broader tension is implied by the author's use of Fisher's tobacco example?", options: ["That even rigorous statistical minds are prone to ideological bias.", "That earlier generations of statisticians failed to appreciate counterfactual reasoning.", "That personal beliefs, not methodology, explain the errors of the past.", "That science progresses through refuting ideas rather than building on them."], correctAnswer: "A", explanation: "A (Correct): Ronald Fisher, a 'giant of statistical theory,' [cite: 6] 'responded dismissively' to the link between smoking and lung cancer, arguing for genetic predisposition[cite: 5, 7]. His stance was later proven 'wrong.' [cite: 15] This scenario, where a highly respected scientist dismisses evidence potentially due to preconceived notions or other biases (though the exact nature of bias isn't detailed, dismissal in the face of a new idea suggests it), points to the tension that even rigorous minds can be biased. \nB (Incorrect): The passage doesn't state earlier generations failed to appreciate counterfactual reasoning; Fisher himself developed much of statistical theory[cite: 6]. The issue was his application or dismissal in this specific case. \nC (Incorrect): This is too strong. While personal beliefs might play a role, the passage doesn't explicitly state methodology is irrelevant to errors. Fisher's own methods would later be used to establish the very link he had denied[cite: 8]. \nD (Incorrect): While refutation is part of science, the passage highlights Fisher's methods being used to establish the link he denied[cite: 8], suggesting a more complex interplay of building upon and refuting ideas." },
            // Questions for Passage 2: Werner Heisenberg
            { passageIndex: 1, text: "Which of the following best captures the central insight of the passage?", options: ["Scientific knowledge is always evolving as new models become available.", "The most responsible scientists today avoid making absolute predictions.", "Our frameworks for understanding the world inevitably shape the knowledge we generate.", "Quantum physics and climate science operate under fundamentally different notions of uncertainty."], correctAnswer: "C", explanation: "C (Correct): The final sentence of the passage states, 'The challenge is not simply to reduce uncertainty, but to understand what kind of truth can be claimed and what kinds cannot-when knowledge itself is both informed and constrained by the frameworks we choose to use.' [cite: 84] This directly summarizes the central theme that our chosen frameworks (Heisenberg's principle[cite: 72, 73], climate models [cite: 76, 77]) define the boundaries and nature of our knowledge. \nA (Incorrect): While true and implied (e.g. Newtonian ideals challenged [cite: 73]), this is not as encompassing as the idea that the very frameworks shape knowledge. \nB (Incorrect): The passage discusses communicating uncertainty (e.g., IPCC's probability ranges [cite: 78]), not necessarily avoiding absolute predictions altogether, but understanding their context. This is a specific example, not the central insight. \nD (Incorrect): The passage draws a parallel between the epistemological dilemmas faced in quantum physics (Heisenberg [cite: 72, 83]) and climate science[cite: 75, 83], suggesting shared challenges in dealing with uncertainty, rather than fundamentally different notions being the core message." },
            { passageIndex: 1, text: "Why does the passage mention Heisenberg's Uncertainty Principle?", options: ["To illustrate how scientific understanding often originates in fundamental measurement errors.", "To argue that the scientific method has moved away from deterministic thinking.", "To highlight that many modern theories are not based on direct observation.", "To compare quantum indeterminacy with the unpredictability inherent in large-scale models."], correctAnswer: "D", explanation: "D (Correct): The passage introduces Heisenberg's Uncertainty Principle as an example of inherent limits to knowledge in physics[cite: 72, 73]. It then explicitly states, 'Fast forward to today, and uncertainty is once again at the centre of physics-not in the quantum domain, but in climate science.' [cite: 75] It then discusses the probabilistic nature of climate models [cite: 78] and the 'epistemological dilemma of acting amid ambiguity,' [cite: 83] explicitly linking the challenges. \nA (Incorrect): The passage states the Uncertainty Principle 'wasn't a limitation of technology but a feature of reality itself,' [cite: 73] not an error. \nB (Incorrect): While a consequence (challenging Newtonian ideals of objectivity [cite: 73]), the primary reason for mentioning it is to set up the comparison with climate science uncertainty. \nC (Incorrect): The Uncertainty Principle is about limitations in simultaneous measurement[cite: 72], not necessarily a lack of direct observation as its primary illustrative point in this context." },
            { passageIndex: 1, text: "What is implied about the communication of uncertainty in scientific practice?", options: ["That reducing uncertainty is the most important goal of modern science.", "That presenting uncertainty transparently may paradoxically erode public trust.", "That scientific models are invalidated if they include probabilistic elements.", "That uncertainty cannot be quantified in complex systems like the climate."], correctAnswer: "B", explanation: "B (Correct): The passage states, 'The paradox is sharp: a model that admits uncertainty might be more trustworthy, not less-yet may appear weaker in the eyes of decision-makers.' [cite: 82] It also notes that some worry communicating uncertainty 'fuels skepticism or inaction, especially when public policy demands clear guidance.' [cite: 81] This suggests a paradoxical situation where transparency about uncertainty can negatively impact public or decision-maker perception. \nA (Incorrect): The passage concludes the challenge is 'not simply to reduce uncertainty, but to understand what kind of truth can be claimed.' [cite: 84] \nC (Incorrect): The IPCC example shows models with probabilistic elements are standard practice[cite: 78]. \nD (Incorrect): The IPCC uses 'probability ranges, confidence levels, and carefully worded caveats,' [cite: 78] which are forms of quantification." },
            { passageIndex: 1, text: "Which of the following most accurately reflects the passage's treatment of truth in science?", options: ["Scientific truth is best understood as a set of probabilistic approximations, not exact outcomes.", "Truth in science is constrained by both the complexity of the world and the models we use to describe it.", "Truth is an illusion perpetuated by models that appear more predictive than they really are.", "Truth in science becomes less important than consensus when uncertainty is high."], correctAnswer: "B", explanation: "B (Correct): The passage concludes, 'The challenge is not simply to reduce uncertainty, but to understand what kind of truth can be claimed and what kinds cannot-when knowledge itself is both informed and constrained by the frameworks we choose to use.' [cite: 84] This explicitly states that the knowledge (truth) we can claim is shaped by our frameworks (models) and inherently by the nature of what we study (complexity of the world, like quantum reality or climate systems). \nA (Incorrect): While probabilistic approximations are mentioned for climate science[cite: 78], the passage also discusses Heisenberg's principle, which is a fundamental feature of reality[cite: 73], not just an approximation. Option B is more encompassing. \nC (Incorrect): The passage doesn't call truth an illusion but discusses the nature and limits of what can be claimed as truth. \nD (Incorrect): The passage doesn't discuss consensus as a replacement for truth; it focuses on understanding the nature of knowledge within uncertainty." },
            // Questions for Passage 3: Partition of British India
            { passageIndex: 2, text: "Which of the following best explains the author's attitude toward the British role in the partition?", options: ["The British tried their best to manage an ungovernable situation.", "The British were neutral administrators caught between conflicting demands.", "The British were active agents in creating the divisions that led to partition.", "The British left India prematurely due to mounting internal political opposition."], correctAnswer: "C", explanation: "C (Correct): The passage states partition was a 'culmination of colonial strategies that had long reinforced division' [cite: 143] and 'emerged from decades of British administrative choices' [cite: 144] like separate electorates[cite: 145]. The conclusion refers to the 'longer imperial logic: divide, govern, and retreat.' [cite: 157] This language points to an active, causal role of the British in fostering division. \nA (Incorrect): The description of Radcliffe's appointment ('never been to India, lacked local knowledge, and was given outdated maps and incomplete census data'[cite: 151], five weeks [cite: 152]) and the catastrophic outcomes do not suggest the British 'tried their best' in a competent manner. \nB (Incorrect): The passage directly attributes the cementing of religious identity in politics to British reforms[cite: 145, 146], implying they were not neutral. \nD (Incorrect): While imperial fatigue [cite: 147] and riots [cite: 149] hastened withdrawal, the author's primary focus regarding the *British role in the partition itself* (the division) is on their long-term strategies of division[cite: 143, 144], not just the timing of their departure." },
            { passageIndex: 2, text: "The author would most likely agree with which of the following statements?", options: ["Communal identities in colonial India were reinforced rather than naturally occurring.", "The Radcliffe Line was a fair attempt to divide the region impartially.", "British colonialism ended peacefully in the Indian subcontinent.", "The legacy of Partition has largely faded from contemporary politics."], correctAnswer: "A", explanation: "A (Correct): The passage states that colonial strategies 'had long reinforced division' [cite: 143] and that administrative choices like separate electorates were 'cementing religious identity within political representation' [cite: 145] and 'embedding religious separateness into governance.' [cite: 146] This strongly supports the idea that these identities were actively reinforced by colonial actions. \nB (Incorrect): The passage describes Sir Cyril Radcliffe as having 'never been to India, lacked local knowledge, and was given outdated maps and incomplete census data,' [cite: 151] and expected to deliver the boundary in 'just five weeks.' [cite: 152] This hardly suggests a fair or impartial attempt in practice. \nC (Incorrect): The passage details riots where 'over 4,000 people died,' [cite: 149] displacement of '14 million people,' [cite: 154] and a death toll from partition violence 'ranging from 200,000 to over two million.' [cite: 155] This is the opposite of peaceful. \nD (Incorrect): The passage states Partition 'forcibly redefined identity, land, and memory.' [cite: 156] While it doesn't explicitly discuss contemporary politics, such profound redefinitions are unlikely to fade quickly, making this option less likely than A, which is strongly supported." },
            { passageIndex: 2, text: "Which of the following best captures a central paradox suggested by the passage?", options: ["A religious partition was used to create peace, yet it generated widespread violence.", "The Indian National Congress and Muslim League both promoted unity but ultimately supported division.", "The British aimed for swift disengagement but retained long-term influence over the region.", "Partition strengthened national identity while simultaneously destroying local ones."], correctAnswer: "A", explanation: "A (Correct): Partition was 'presented as a solution' [cite: 157] and implemented after events like the Direct Action Day riots[cite: 149], implying it was intended to resolve conflict or establish order. However, the passage then details the immense violence and displacement: '14 million people were displaced,' [cite: 154] and 'The death toll ... [was] 200,000 to over two million.' [cite: 155] An action meant to solve a problem (discord/violence) leading to massive violence is a clear paradox. \nB (Incorrect): The passage focuses on the British role and the consequences of partition, not the internal motivations or paradoxical actions of Indian political parties in this way. \nC (Incorrect): The passage emphasizes 'rapid disengagement' due to 'imperial fatigue' [cite: 147] and doesn't discuss retained long-term influence. \nD (Incorrect): While partition did redefine identities[cite: 156], the primary paradox highlighted is the violence resulting from an ostensible solution." },
            { passageIndex: 2, text: "What is the central irony implied by the passage?", options: ["The British left India peacefully despite having caused most of its internal conflict.", "A project meant to unify India ultimately fractured it more than ever before.", "The administrative tools used to govern India ended up dismantling it.", "The people of India wanted partition, but were unprepared for the consequences."], correctAnswer: "C", explanation: "C (Correct): The passage details how 'British administrative choices' [cite: 144] like the Morley-Minto Reforms [cite: 145] and the Government of India Act [cite: 146] (tools of governance) introduced and expanded separate electorates, 'cementing religious identity' [cite: 145] and 'embedding religious separateness.' [cite: 146] These very tools, designed for administration and control, are presented as having 'reinforced division' [cite: 143] and culminated in the partition (dismantling of British India into two nations [cite: 150]). This is a strong irony. \nA (Incorrect): The British departure was far from peaceful, as described by the riots [cite: 149] and mass killings[cite: 155]. \nB (Incorrect): The passage doesn't describe a British 'project meant to unify India' that then fractured it; rather, it describes administrative choices that reinforced division. \nD (Incorrect): The passage does not delve into whether the general populace wanted partition or their preparedness, focusing more on British actions and high-level political decisions." },
            // Questions for Passage 4: Attention Economy
            { passageIndex: 3, text: "The passage suggests that users are unaware of how much control platforms have over their behaviour.", options: ["True", "False", "Can't Tell"], correctAnswer: "A", explanation: "A (True): The passage states: 'A 2022 study by the Institute for Media Ethics found that over 70% of users believed they had control over their content feed, while over 60% of their interactions could be predicted by platform algorithms.' [cite: 232] This discrepancy between users' belief in their control and the predictability of their interactions by algorithms strongly suggests an unawareness of the extent of platform influence. \nB (False): This contradicts the evidence from the study cited[cite: 232]. \nC (Can't Tell): The passage provides direct evidence through the study to support the suggestion[cite: 232]." },
            { passageIndex: 3, text: "Critics of digital platforms agree that personalised recommendations improve user choice.", options: ["True", "False", "Can't Tell"], correctAnswer: "B", explanation: "B (False): The passage states: 'Critics contend this architecture is manipulative, encouraging compulsive use rather than genuine exploration.' [cite: 227] Personalised recommendations are listed as one of the 'techniques ... designed not only to serve content but to keep users in a continuous loop of consumption.' [cite: 226] This implies critics view such recommendations as tools for manipulation that hinder genuine choice, rather than improving it. \nA (True): This is the opposite of what critics argue according to the text[cite: 227]. \nC (Can't Tell): The passage clearly outlines the critics' perspective[cite: 227]." },
            { passageIndex: 3, text: "According to the passage, users who intentionally curate their digital environments can avoid manipulation.", options: ["True", "False", "Can't Tell"], correctAnswer: "C", explanation: "C (Can't Tell): The passage presents the proponents' view: 'digital systems expand, rather than narrow, user agency if used intentionally.' [cite: 230] This suggests intentional use *can expand agency*. However, it immediately follows with 'Still, the question remains whether users are primarily choosing or being chosen for,' [cite: 231] and then cites the study showing a discrepancy between perceived and actual control[cite: 232]. The passage ends by stating the issue 'remains a matter of debate.' [cite: 233] It doesn't definitively state that intentional curation allows users to *avoid manipulation* entirely, only that proponents believe it can help. The overall stance is one of unresolved debate. \nA (True): This is too strong a conclusion; the passage presents this as a proponent's view [cite: 230] but then casts doubt[cite: 231, 232, 233]. \nB (False): The passage doesn't explicitly state that intentional curation *cannot* help avoid manipulation, only that the question is complex and debated[cite: 233]." },
            { passageIndex: 3, text: "The profitability of digital platforms depends on how long users stay engaged.", options: ["True", "False", "Can't Tell"], correctAnswer: "A", explanation: "A (True): The passage states that platforms 'are engineered to maximise user engagement' [cite: 222] and 'As users spend more time within these platforms, advertisers gain more impressions, and the platforms become more profitable.' [cite: 223] This directly links the duration of user engagement to the profitability of the platforms. \nB (False): This contradicts the direct statements in the passage[cite: 223]. \nC (Can't Tell): The passage provides clear information to confirm this statement[cite: 223]." }
        ];


        // --- State ---
        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let timerInterval;
        let timeLeft = 10 * 60; // 10 minutes in seconds for 16 questions
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = new Array(questions.length).fill(0);
        let flaggedQuestions = new Array(questions.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPassageIndex = -1;


        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button'); 
        const endExamButtonFooter = document.getElementById('end-exam-button-footer'); 
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const passageNumberEl = document.getElementById('passage-number');
        const passageTextEl = document.getElementById('passage-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsGridContainer = document.getElementById('results-grid-container'); 
        const nameInput = document.getElementById('name');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');



        // --- Functions ---

        function startTimer() {
            examStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300'); 
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endExamAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            examEndTime = examEndTime || new Date(); 
            timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            timerEl.classList.add('text-gray-300'); 
        }

        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0; 
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

       
        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent; 
            }
            questionStartTime = null; 
        }

       
        function toggleFlag() {
            if (isReviewingFromResults) return; 
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons(); 
        }

       
        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }


        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questions.length) return;

            
             
             if (!isReviewingFromResults && !reviewMode) { 
                 recordTimeSpent(currentQuestionIndex);
            }

            const question = questions[index];
            const newPassageIndex = question.passageIndex;
            const passageContainer = document.querySelector('.passage-column');
            const questionContainer = document.querySelector('.question-column');

           
            if (newPassageIndex !== currentlyDisplayedPassageIndex || reviewMode) {
                passageTextEl.innerHTML = passages[newPassageIndex].replace(/\n/g, '<br><br>');
                passageNumberEl.textContent = newPassageIndex + 1;
                currentlyDisplayedPassageIndex = newPassageIndex;
                 if (passageContainer) passageContainer.scrollTop = 0; 
            }

            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode; 

            questionNumberEl.textContent = index + 1;
            questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`;
            questionTextEl.textContent = question.text;
             if (questionContainer) questionContainer.scrollTop = 0; 

            optionsContainer.innerHTML = '';
            reviewExplanationContainer.innerHTML = ''; 
            const optionLetters = ['A', 'B', 'C', 'D', 'E']; 
            question.options.forEach((option, i) => {
                const optionId = `q${index}_opt${i}`;
                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.classList.add('option-label'); // Styles for this are in CSS, including text color and size
                label.dataset.optionIndex = i; 

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.id = optionId;
                radio.name = `question_${index}`;
                radio.value = optionLetters[i]; 
                radio.disabled = reviewMode; 

                
                label.classList.remove('border-green-500', 'border-red-500', 'border-2', 'bg-green-50', 'bg-red-50', 'selected-answer');
                label.style.cursor = reviewMode ? 'default' : 'pointer';


                if (userAnswers[index] === optionLetters[i]) {
                    radio.checked = true;
                    label.classList.add('selected-answer');
                }

               
                if (reviewMode) {
                    const isCorrectAnswer = question.correctAnswer === optionLetters[i];
                    const isSelectedAnswer = userAnswers[index] === optionLetters[i];

                    if (isCorrectAnswer) {
                        label.classList.add('border-green-500', 'border-2'); 
                        if (!isSelectedAnswer) label.classList.add('bg-green-50'); 
                    } else if (isSelectedAnswer) { 
                        label.classList.add('border-red-500', 'border-2', 'bg-red-50');
                    }
                }

                label.appendChild(radio);
                const textNode = document.createTextNode(`${optionLetters[i]}) ${option}`);
                label.appendChild(textNode);

                if (!reviewMode) {
                    label.addEventListener('click', (e) => {
                         
                        if (e.target.tagName !== 'INPUT') {
                            handleOptionSelect(index, i, optionLetters[i]);
                        }
                    });
                    radio.addEventListener('change', () => handleOptionSelect(index, i, optionLetters[i]));
                }
                optionsContainer.appendChild(label);
            });

           
            if (reviewMode && question.explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.classList.add('explanation-box'); 
                explanationDiv.innerHTML = `<strong class="font-semibold">Explanation:</strong> ${question.explanation.replace(/\n/g, '<br>')}`; 
                reviewExplanationContainer.appendChild(explanationDiv);
            }
           


            prevButton.disabled = index === 0;
            if (!reviewMode && index === questions.length - 1) { 
                 nextButton.textContent = 'Finish & Review';
                 nextButton.disabled = false;
            } else if (!reviewMode) { 
                 nextButton.textContent = 'Next (Alt+N) →';
                 nextButton.disabled = false;
            } else { 
                 nextButton.disabled = index === questions.length - 1;
                 if (!nextButton.disabled) nextButton.textContent = 'Next →'; 
            }

            updateFlagButtonAppearance();

           
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endExamButtonFooter.classList.add('hidden');
                examTitleEl.textContent = "Reviewing Question";
                prevButton.disabled = index === 0; 
                navigatorButton.disabled = false; 
                flagButton.disabled = true; 
            } else { 
                backToResultsButton.classList.add('hidden');
                endExamButtonFooter.classList.remove('hidden');
                examTitleEl.textContent = "Verbal Reasoning";
                navigatorButton.disabled = false;
                flagButton.disabled = false;
                prevButton.disabled = index === 0;
            }

            updateNavigatorHighlight(); 

           
            if (!isReviewingFromResults) { 
                questionStartTime = Date.now();
            }
        }

         function handleOptionSelect(questionIndex, optionIndex, optionValue) {
             
             if (questionIndex !== currentQuestionIndex || isReviewingFromResults) return;
             userAnswers[questionIndex] = optionValue;

             
             document.querySelectorAll(`#options-container .option-label`).forEach(lbl => {
                 lbl.classList.remove('selected-answer');
                 const radio = lbl.querySelector('input[type="radio"]');
                 if(radio) radio.checked = false; 
             });

             const selectedLabel = document.querySelector(`#options-container label[for="q${questionIndex}_opt${optionIndex}"]`);
              if (selectedLabel) {
                 selectedLabel.classList.add('selected-answer');
                 const radio = selectedLabel.querySelector('input[type="radio"]');
                 if (radio) radio.checked = true; 
             }
             updateNavigatorButtons(); 
         }


        function showNextQuestion() {
            if (isReviewingFromResults) { 
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true); 
                }
            }
            else if (!isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 if (currentQuestionIndex === questions.length - 1) { 
                     stopTimer(); 
                     showReviewScreen(); 
                 } else if (currentQuestionIndex < questions.length - 1) {
                     loadQuestion(currentQuestionIndex + 1); 
                 }
            }
        }


        function showPrevQuestion() {
             if (isReviewingFromResults) { 
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true); 
                 }
             }
            else if (currentQuestionIndex > 0 && !isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            setupScreen.classList.remove('hidden');
            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
           
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = questions.length;
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `${Math.floor(timeLeft / 60)} minutes`;

        }

        function showExamScreen() {
            setupScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            examScreen.classList.add('flex'); 
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
        }


        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            reviewGrid.innerHTML = ''; 
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) { 
                     return;
                 }

                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button'; 

                if (userAnswers[index] !== null && userAnswers[index] !== undefined) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }

                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged'); 
                }

                button.onclick = () => {
                    reviewScreen.classList.add('hidden'); 
                    reviewScreen.classList.remove('flex');
                    showExamScreen(); 
                    loadQuestion(index); 
                    startTimer(); 
                };
                reviewGrid.appendChild(button);
            });

             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

         function populateNavigator() {
             navigatorGrid.innerHTML = ''; 
             questions.forEach((_, index) => {
                 const button = document.createElement('button');
                 button.textContent = index + 1;
                 
                 button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                 button.dataset.questionIndex = index; 

                 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');

                 button.onclick = () => {
                     navigatorModal.classList.remove('flex'); 
                     navigatorModal.classList.add('hidden');
                     const targetIndex = parseInt(button.dataset.questionIndex, 10);
                     
                     loadQuestion(targetIndex, isReviewingFromResults);
                     if (!isReviewingFromResults) questionStartTime = Date.now(); 
                 };
                 navigatorGrid.appendChild(button);
             });
         }

        function updateNavigatorButtons() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-answered', 'nav-current', 'nav-flagged'); 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');
             });
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            examEndTime = examEndTime || new Date(); 
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            let score = 0;
            resultsGridContainer.innerHTML = ''; 

            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                if (isCorrect) score++;

                const timeSpentMs = questionTimes[index] || 0; 
                const timeSpentSec = Math.round(timeSpentMs / 1000);

                const resultBox = document.createElement('div');
                resultBox.classList.add('result-box');
                resultBox.classList.add(isCorrect ? 'result-box-correct' : 'result-box-incorrect');
                if (flaggedQuestions[index]) {
                    resultBox.classList.add('result-box-flagged');
                }
                resultBox.dataset.index = index; 
                resultBox.title = `Click to review Question ${index + 1}`;

                const timeDiv = document.createElement('div');
                timeDiv.classList.add('time-spent');
                timeDiv.textContent = `${timeSpentSec}s`;
                resultBox.appendChild(timeDiv);

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.alignItems = 'center';
                container.appendChild(resultBox);

                const qNumDiv = document.createElement('div');
                qNumDiv.classList.add('question-num-label');
                qNumDiv.textContent = `Q${index + 1}`;
                container.appendChild(qNumDiv);
               
                container.addEventListener('click', () => {
                    revisitQuestionFromResults(index);
                });
                resultsGridContainer.appendChild(container);
            });

            scoreEl.textContent = score;
            totalQuestionsResultsEl.textContent = questions.length;
            const timeDiff = examEndTime - examStartTime;
            timeTakenEl.textContent = formatTimeDifference(timeDiff);
        }


        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showExamScreen();
            loadQuestion(index, true); 
        }

        function endExamAndShowResults() {
            stopTimer(); 
            showResultsScreen();
        }
         function handleEndExamFooterClick() {
             recordTimeSpent(currentQuestionIndex); 
             stopTimer();
             showReviewScreen(); 
         }

       
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRating = focusRatingInput.value; 
            const finalScore = scoreEl.textContent;
            const totalQ = totalQuestionsResultsEl.textContent; 
            const timeTaken = timeTakenEl.textContent;

            let y = 15; 
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;
            const pageWidth = doc.internal.pageSize.width;


           
            doc.setFontSize(18);
            doc.text("UCAT Verbal Reasoning Results", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;

           
            doc.setFontSize(12);
            const summaryData = [
                ["Name:", userName || 'N/A'],
                ["Goal:", `${userGoal || 'N/A'} / ${totalQ}`],
                ["Focus Area:", userFocusArea || 'N/A'],
                ["Final Score:", `${finalScore} / ${totalQ}`],
                ["Time Taken:", timeTaken],
                ["Focus Rating (1-5):", focusRating || 'N/A']
            ];

            summaryData.forEach(row => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.setFont(undefined, 'bold');
                doc.text(row[0], margin, y);
                doc.setFont(undefined, 'normal');
                doc.text(row[1], margin + 40, y);
                y += lineHeight;
            });
            y += lineHeight; 

           
            if (y > pageHeight - margin - (lineHeight*3)) { doc.addPage(); y = margin; } 
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Main Takeaway:", margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', pageWidth - margin * 2);
            reflectionLines.forEach(line => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.text(line, margin, y);
                y += (lineHeight * 0.8);
            });
            y += lineHeight; 

           
            if (y > pageHeight - margin - (lineHeight*2)) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Detailed Results:", margin, y);
            y += lineHeight * 1.5;
            doc.setFontSize(9); 
            doc.setFont(undefined, 'normal');

           
            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                const status = isCorrect ? "Correct" : (userAnswer ? "Incorrect" : "Not Answered");
                const timeSpentSec = Math.round((questionTimes[index] || 0) / 1000);

                const questionDetails = [
                    `Q${index + 1}: ${qData.text.substring(0, 60)}...${flaggedQuestions[index] ? ' (Flagged)' : ''}`,
                    `  Your Answer: ${userAnswer || 'N/A'}`,
                    `  Correct Answer: ${correctAnswer}`,
                    `  Status: ${status}`,
                    `  Time: ${timeSpentSec}s`
                ];

               
                const blockHeight = questionDetails.length * (lineHeight * 0.75) + (qData.explanation ? 3 * (lineHeight*0.75) : 0);
                if (y + blockHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin; 
                   
                    doc.setFontSize(14); doc.setFont(undefined, 'bold');
                    doc.text("Detailed Results (Continued):", margin, y);
                    y += lineHeight * 1.5;
                    doc.setFontSize(9); doc.setFont(undefined, 'normal');
                }

                questionDetails.forEach(detailLine => {
                    doc.text(detailLine, margin, y);
                    y += (lineHeight * 0.75);
                });

                if (qData.explanation) {
                    const explLines = doc.splitTextToSize(`  Explanation: ${qData.explanation.replace(/\n/g, ' ')}`, pageWidth - (margin * 2.5)); 
                    explLines.forEach(explLine => {
                         if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                         doc.text(explLine, margin + 5, y); 
                         y += (lineHeight * 0.75);
                    });
                }
                y += (lineHeight * 0.5); 
            });

            doc.save(`ucat_vr_results_${userName.replace(/\s+/g, '_') || 'user'}.pdf`);
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            userName = nameInput.value.trim();
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();

           
            timeLeft = 10 * 60; 
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false; 
            currentlyDisplayedPassageIndex = -1; 

            showExamScreen();
            startTimer(); 
            loadQuestion(0);
            populateNavigator(); 
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults); 
        endExamButtonFooter.addEventListener('click', handleEndExamFooterClick); 
        backToResultsButton.addEventListener('click', () => {
            isReviewingFromResults = false; 
            showResultsScreen(); 
        });
        navigatorButton.addEventListener('click', () => {
             recordTimeSpent(currentQuestionIndex); 
            updateNavigatorButtons(); 
            navigatorModal.classList.remove('hidden');
            navigatorModal.classList.add('flex');
        });
        closeModalButton.addEventListener('click', () => {
             navigatorModal.classList.remove('flex');
             navigatorModal.classList.add('hidden');
             if (!isReviewingFromResults) questionStartTime = Date.now(); 
        });
       
        navigatorModal.addEventListener('click', (event) => {
            if (event.target === navigatorModal) closeModalButton.click();
        });

        flagButton.addEventListener('click', toggleFlag);

        filterFlaggedButton.addEventListener('click', () => {
            isFilteringFlagged = !isFilteringFlagged;
            showReviewScreen(isFilteringFlagged); 
        });

       
        downloadPdfButton.addEventListener('click', generatePDF);


       
        function handleKeyboardShortcuts(e) {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');

             if (isModalVisible || isInputFocused) return; 
             if (!isExamVisible) return; 

             const key = e.key.toLowerCase();
             const altOrOption = e.altKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': 
                         e.preventDefault();
                         if (!nextButton.disabled) nextButton.click();
                         return;
                     case 'keyp': 
                         e.preventDefault();
                         if (!prevButton.disabled) prevButton.click();
                         return;
                     case 'keyf': 
                         e.preventDefault();
                         if (!isReviewingFromResults && !flagButton.disabled) flagButton.click();
                         return;
                     default:
                         return; 
                 }
             } else { 
                 
                 if (['a', 'b', 'c', 'd'].includes(key) && !isReviewingFromResults) {
                     e.preventDefault();
                     const optionIndex = ['a', 'b', 'c', 'd'].indexOf(key);
                     const optionValue = ['A', 'B', 'C', 'D'][optionIndex];
                     const currentQuestionData = questions[currentQuestionIndex];
                     if (optionIndex < currentQuestionData.options.length) { 
                         handleOptionSelect(currentQuestionIndex, optionIndex, optionValue);
                     }
                     return;
                 }
             }
        }

        document.addEventListener('keydown', handleKeyboardShortcuts);


        // --- Initial Load ---
        showSetupScreen(); // Start with the setup screen

    </script>
</body>
</html>
